{"ast":null,"code":"import React,{useState,useEffect,useContext}from\"react\";import{makeStyles,useTheme}from\"@material-ui/core/styles\";import api from\"../../services/api\";import{AuthContext}from\"../../context/Auth/AuthContext\";import Board from'react-trello';import{toast}from\"react-toastify\";import{i18n}from\"../../translate/i18n\";import{useHistory}from'react-router-dom';import{Facebook,Instagram,WhatsApp}from\"@material-ui/icons\";import{Badge,Tooltip,Typography,Button,TextField,Box}from\"@material-ui/core\";import{format,isSameDay,parseISO}from\"date-fns\";import{Can}from\"../../components/Can\";import Avatar from\"@material-ui/core/Avatar\";const useStyles=makeStyles(theme=>({root:{display:\"flex\",flexDirection:\"column\",alignItems:\"center\",padding:theme.spacing(1)},kanbanContainer:{width:\"100%\",maxWidth:\"1200px\",margin:\"0 auto\"},connectionTag:{background:\"green\",color:\"#FFF\",marginRight:1,padding:1,fontWeight:'bold',borderRadius:3,fontSize:\"0.6em\"},lastMessageTime:{justifySelf:\"flex-end\",textAlign:\"right\",position:\"relative\",marginLeft:\"auto\",color:theme.palette.text.secondary},lastMessageTimeUnread:{justifySelf:\"flex-end\",textAlign:\"right\",position:\"relative\",color:theme.palette.success.main,fontWeight:\"bold\",marginLeft:\"auto\"},cardButton:{marginRight:theme.spacing(1),color:theme.palette.common.white,backgroundColor:theme.palette.primary.main,\"&:hover\":{backgroundColor:theme.palette.primary.dark}},dateInput:{marginRight:theme.spacing(2)}}));const Kanban=()=>{const classes=useStyles();const theme=useTheme();// Obter o tema atual\nconst history=useHistory();const{user,socket}=useContext(AuthContext);const[tags,setTags]=useState([]);const[tickets,setTickets]=useState([]);const[ticketNot,setTicketNot]=useState(0);const[file,setFile]=useState({lanes:[]});const[startDate,setStartDate]=useState(format(new Date(),\"yyyy-MM-dd\"));const[endDate,setEndDate]=useState(format(new Date(),\"yyyy-MM-dd\"));const jsonString=user.queues.map(queue=>queue.UserQueue.queueId);useEffect(()=>{fetchTags();},[user]);const fetchTags=async()=>{try{const response=await api.get(\"/tag/kanban/\");const fetchedTags=response.data.lista||[];setTags(fetchedTags);fetchTickets();}catch(error){console.log(error);}};const fetchTickets=async()=>{try{const{data}=await api.get(\"/ticket/kanban\",{params:{queueIds:JSON.stringify(jsonString),startDate:startDate,endDate:endDate}});setTickets(data.tickets);}catch(err){console.log(err);setTickets([]);}};useEffect(()=>{const companyId=user.companyId;const onAppMessage=data=>{if(data.action===\"create\"||data.action===\"update\"||data.action===\"delete\"){fetchTickets();}};socket.on(\"company-\".concat(companyId,\"-ticket\"),onAppMessage);socket.on(\"company-\".concat(companyId,\"-appMessage\"),onAppMessage);return()=>{socket.off(\"company-\".concat(companyId,\"-ticket\"),onAppMessage);socket.off(\"company-\".concat(companyId,\"-appMessage\"),onAppMessage);};},[socket,startDate,endDate]);const handleSearchClick=()=>{fetchTickets();};const handleStartDateChange=event=>{setStartDate(event.target.value);};const handleEndDateChange=event=>{setEndDate(event.target.value);};const IconChannel=channel=>{switch(channel){case\"facebook\":return/*#__PURE__*/React.createElement(Facebook,{style:{color:\"#3b5998\",verticalAlign:\"middle\",fontSize:\"16px\"}});case\"instagram\":return/*#__PURE__*/React.createElement(Instagram,{style:{color:\"#e1306c\",verticalAlign:\"middle\",fontSize:\"16px\"}});case\"whatsapp\":return/*#__PURE__*/React.createElement(WhatsApp,{style:{color:\"#25d366\",verticalAlign:\"middle\",fontSize:\"16px\"}});default:return\"error\";}};const popularCards=jsonString=>{const filteredTickets=tickets.filter(ticket=>ticket.tags.length===0);const lanes=[{id:\"lane0\",title:i18n.t(\"tagsKanban.laneDefault\"),label:filteredTickets.length.toString(),cards:filteredTickets.map(ticket=>{var _ticket$user,_ticket$whatsapp;return{id:ticket.id.toString(),label:\"Ticket nº \"+ticket.id.toString(),description:/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"div\",{style:{display:'flex',justifyContent:'space-between'}},/*#__PURE__*/React.createElement(\"span\",null,ticket.contact.number),/*#__PURE__*/React.createElement(Typography,{className:Number(ticket.unreadMessages)>0?classes.lastMessageTimeUnread:classes.lastMessageTime,component:\"span\",variant:\"body2\"},isSameDay(parseISO(ticket.updatedAt),new Date())?/*#__PURE__*/React.createElement(React.Fragment,null,format(parseISO(ticket.updatedAt),\"HH:mm\")):/*#__PURE__*/React.createElement(React.Fragment,null,format(parseISO(ticket.updatedAt),\"dd/MM/yyyy\")))),/*#__PURE__*/React.createElement(\"div\",{style:{textAlign:'left'}},ticket.lastMessage||\" \"),/*#__PURE__*/React.createElement(Button,{className:\"\".concat(classes.button,\" \").concat(classes.cardButton),onClick:()=>{handleCardClick(ticket.uuid);}},\"Ver Ticket\"),/*#__PURE__*/React.createElement(\"span\",{style:{marginRight:'8px'}}),(ticket===null||ticket===void 0?void 0:ticket.user)&&/*#__PURE__*/React.createElement(Badge,{style:{backgroundColor:\"#000000\"},className:classes.connectionTag},(_ticket$user=ticket.user)===null||_ticket$user===void 0?void 0:_ticket$user.name.toUpperCase())),title:/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(Avatar,{src:ticket.whatsapp.profilePicUrl,style:{width:24,height:24,marginRight:8},onError:e=>{e.target.src='https://via.placeholder.com/24';// Substitua pela URL de uma imagem de placeholder\n}}),/*#__PURE__*/React.createElement(Tooltip,{title:(_ticket$whatsapp=ticket.whatsapp)===null||_ticket$whatsapp===void 0?void 0:_ticket$whatsapp.name},IconChannel(ticket.channel)),\" \",ticket.contact.name),draggable:true,href:\"/tickets/\"+ticket.uuid};})},...tags.map(tag=>{const filteredTickets=tickets.filter(ticket=>{const tagIds=ticket.tags.map(tag=>tag.id);return tagIds.includes(tag.id);});return{id:tag.id.toString(),title:tag.name,label:filteredTickets===null||filteredTickets===void 0?void 0:filteredTickets.length.toString(),cards:filteredTickets.map(ticket=>{var _ticket$user2,_ticket$whatsapp2;return{id:ticket.id.toString(),label:\"Ticket nº \"+ticket.id.toString(),description:/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"p\",null,ticket.contact.number,/*#__PURE__*/React.createElement(\"br\",null),ticket.lastMessage||\" \"),/*#__PURE__*/React.createElement(Button,{className:\"\".concat(classes.button,\" \").concat(classes.cardButton),onClick:()=>{handleCardClick(ticket.uuid);}},\"Ver Ticket\"),/*#__PURE__*/React.createElement(\"span\",{style:{marginRight:'8px'}}),/*#__PURE__*/React.createElement(\"p\",null,(ticket===null||ticket===void 0?void 0:ticket.user)&&/*#__PURE__*/React.createElement(Badge,{style:{backgroundColor:\"#000000\"},className:classes.connectionTag},(_ticket$user2=ticket.user)===null||_ticket$user2===void 0?void 0:_ticket$user2.name.toUpperCase()))),title:/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(Tooltip,{title:(_ticket$whatsapp2=ticket.whatsapp)===null||_ticket$whatsapp2===void 0?void 0:_ticket$whatsapp2.name},IconChannel(ticket.channel)),\" \",ticket.contact.name),draggable:true,href:\"/tickets/\"+ticket.uuid};}),style:{backgroundColor:tag.color,color:\"white\"}};})];setFile({lanes});};const handleCardClick=uuid=>{history.push('/tickets/'+uuid);};useEffect(()=>{popularCards(jsonString);},[tags,tickets]);const handleCardMove=async(cardId,sourceLaneId,targetLaneId)=>{try{await api.delete(\"/ticket-tags/\".concat(targetLaneId));toast.success('Ticket Tag Removido!');await api.put(\"/ticket-tags/\".concat(targetLaneId,\"/\").concat(sourceLaneId));toast.success('Ticket Tag Adicionado com Sucesso!');await fetchTickets(jsonString);popularCards(jsonString);}catch(err){console.log(err);}};const handleAddConnectionClick=()=>{history.push('/tagsKanban');};return/*#__PURE__*/React.createElement(\"div\",{className:classes.root},/*#__PURE__*/React.createElement(\"div\",{style:{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'20px',width:'100%',maxWidth:'1200px'}},/*#__PURE__*/React.createElement(\"div\",{style:{display:'flex',alignItems:'center'}},/*#__PURE__*/React.createElement(TextField,{label:\"Data de in\\xEDcio\",type:\"date\",value:startDate,onChange:handleStartDateChange,InputLabelProps:{shrink:true},variant:\"outlined\",className:classes.dateInput}),/*#__PURE__*/React.createElement(Box,{mx:1}),/*#__PURE__*/React.createElement(TextField,{label:\"Data de fim\",type:\"date\",value:endDate,onChange:handleEndDateChange,InputLabelProps:{shrink:true},variant:\"outlined\",className:classes.dateInput}),/*#__PURE__*/React.createElement(Box,{mx:1}),/*#__PURE__*/React.createElement(Button,{variant:\"contained\",color:\"primary\",onClick:handleSearchClick},\"Buscar\")),/*#__PURE__*/React.createElement(Can,{role:user.profile,perform:\"dashboard:view\",yes:()=>/*#__PURE__*/React.createElement(Button,{variant:\"contained\",color:\"primary\",onClick:handleAddConnectionClick},'+ Adicionar colunas')})),/*#__PURE__*/React.createElement(\"div\",{className:classes.kanbanContainer},/*#__PURE__*/React.createElement(Board,{data:file,onCardMoveAcrossLanes:handleCardMove,style:{backgroundColor:'rgba(252, 252, 252, 0.03)'}})));};export default Kanban;","map":null,"metadata":{},"sourceType":"module"}