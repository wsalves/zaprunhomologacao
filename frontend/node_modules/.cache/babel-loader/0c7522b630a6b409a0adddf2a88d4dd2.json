{"ast":null,"code":"import React,{Fragment,useContext,useEffect,useMemo,useState}from\"react\";import{useHistory}from\"react-router-dom\";import api from\"../../services/api\";import{i18n}from\"../../translate/i18n\";import toastError from\"../../errors/toastError\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{ReportProblem,VisibilityOutlined}from\"@mui/icons-material\";// import { SocketContext } from \"../../context/Socket/SocketContext\";\nimport{toast}from\"react-toastify\";import{yellow}from\"@mui/material/colors\";import{Avatar,CardHeader,Divider,List,ListItem,ListItemAvatar,ListItemText,Paper,Typography,Card,makeStyles,Container,Badge,Grid,Tooltip}from\"@material-ui/core\";import{format,isSameDay,parseISO}from\"date-fns\";import{grey}from\"@material-ui/core/colors\";import{getBackendUrl}from\"../../config\";const backendUrl=getBackendUrl();const useStyles=makeStyles(theme=>({main:{display:\"flex\",justifyContent:\"space-between\"},container:{display:'flex',flexWrap:'wrap',overflowY:\"scroll\",...theme.scrollbarStyles},cardHeader:{width:\"380px\",height:\"78px\",padding:10,backgroundColor:\"#DCDCDC\"},cardHeaderPending:{width:\"380px\",height:\"78px\",padding:10,backgroundColor:\"#C0C0C0\"},card:{height:\"300px\",width:\"380px\",margin:\"3px\",borderRadius:5,flex:1,maxHeight:\"100%\",overflowY:\"scroll\",...theme.scrollbarStyles,borderTop:\"2px solid rgba(0, 0, 0, 0.12)\"},changeWarap:{width:'380px',padding:0,margin:0},pending:{color:yellow[600],fontSize:'20px'},connectionTag:{background:\"green\",color:\"#FFF\",marginRight:1,padding:1,fontWeight:'bold',// paddingLeft: 5,\n// paddingRight: 5,\nborderRadius:3,fontSize:\"0.6em\"// whiteSpace: \"nowrap\"\n},lastMessageTime:{justifySelf:\"flex-end\",textAlign:\"right\",position:\"relative\",// top: -30,\nmarginRight:\"1px\",color:grey[400]},lastMessageTimeUnread:{justifySelf:\"flex-end\",textAlign:\"right\",position:\"relative\",// top: -30,\ncolor:\"green\",fontWeight:\"bold\",marginRight:\"1px\"},pending:{color:yellow[600],fontSize:'20px'}}));const DashboardManage=()=>{const classes=useStyles();const history=useHistory();//   const socketManager = useContext(SocketContext);\nconst{user,socket}=useContext(AuthContext);const[tickets,setTickets]=useState([]);const[update,setUpdate]=useState(false);const[ticketNot,setTicketNot]=useState(0);const companyId=user.companyId;const userQueueIds=user.queues.map(q=>q.id);const[selectedQueueIds,setSelectedQueueIds]=useState(userQueueIds||[]);useEffect(()=>{(async()=>{try{const{data}=await api.get(\"/usersMoments\");setTickets(data);setUpdate(!update);}catch(err){var _err$response;if(((_err$response=err.response)===null||_err$response===void 0?void 0:_err$response.status)!==500){toastError(err);}else{toast.error(\"\".concat(i18n.t(\"frontEndErrors.getUsers\")));}}})();},[]);useEffect(()=>{const companyId=user.companyId;// const socket = socketManager.GetSocket();\n// const onConnect = () => {\n//   socket.emit(\"joinChatBox\", `${ticketId}`);\n// }\nconst onAppMessage=data=>{if(data.action===\"create\"||data.action===\"update\"||data.action===\"delete\"){(async()=>{try{const{data}=await api.get(\"/usersMoments\");setTickets(data);setUpdate(!update);}catch(err){var _err$response2;if(((_err$response2=err.response)===null||_err$response2===void 0?void 0:_err$response2.status)!==500){toastError(err);}else{toast.error(\"\".concat(i18n.t(\"frontEndErrors.getUsers\")));}}})();}};// socket.on(\"connect\", onConnect);\nsocket.on(\"company-\".concat(companyId,\"-ticket\"),onAppMessage);socket.on(\"company-\".concat(companyId,\"-appMessage\"),onAppMessage);return()=>{// socket.off(\"connect\", onConnect);\nsocket.off(\"company-\".concat(companyId,\"-ticket\"),onAppMessage);socket.off(\"company-\".concat(companyId,\"-appMessage\"),onAppMessage);};},[socket]);const Moments=useMemo(()=>{if(tickets&&tickets.length>0){const ticketsByUser=tickets.reduce((userTickets,ticket)=>{const user=ticket.user;if(user){const userIndex=userTickets.findIndex(group=>group.user.id===user.id);if(userIndex===-1){userTickets.push({user,userTickets:[ticket]});}else{userTickets[userIndex].userTickets.push(ticket);}}return userTickets;},[]);return ticketsByUser.map((group,index)=>{var _group$user,_group$userTickets;return/*#__PURE__*/React.createElement(Grid,{item:true,key:index},/*#__PURE__*/React.createElement(\"div\",{padding:20,className:classes.main,key:index},/*#__PURE__*/React.createElement(\"div\",{className:classes.changeWarap},/*#__PURE__*/React.createElement(Paper,{elevation:3,className:classes.cardHeader},/*#__PURE__*/React.createElement(CardHeader,{style:{maxWidth:'380px',width:'100%'},avatar:/*#__PURE__*/React.createElement(Avatar,{alt:\"\".concat(group.user.profileImage),src:group.user.profileImage?\"\".concat(backendUrl,\"/public/company\").concat(companyId,\"/user/\").concat(group.user.profileImage):null}),title:/*#__PURE__*/React.createElement(\"span\",null,(group===null||group===void 0?void 0:(_group$user=group.user)===null||_group$user===void 0?void 0:_group$user.name)||\"Pendentes\",\" \",/*#__PURE__*/React.createElement(\"br\",null),\"Atendimentos: \".concat((_group$userTickets=group.userTickets)===null||_group$userTickets===void 0?void 0:_group$userTickets.length))})),/*#__PURE__*/React.createElement(Paper,{square:true,elevation:1,className:classes.card},group.userTickets.map(ticket=>{var _ticket$contact,_ticket$contact$name,_ticket$contact2,_ticket$contact3,_ticket$lastMessage,_ticket$whatsapp,_ticket$queue,_ticket$queue2;return/*#__PURE__*/React.createElement(List,{style:{paddingTop:0},key:ticket.id},/*#__PURE__*/React.createElement(ListItem,{dense:true,button:true},/*#__PURE__*/React.createElement(ListItemAvatar,null,/*#__PURE__*/React.createElement(Avatar,{alt:\"\".concat(ticket.contact.urlPicture),src:\"\".concat(ticket.contact.urlPicture)})),/*#__PURE__*/React.createElement(ListItemText,{disableTypography:true,primary:(ticket===null||ticket===void 0?void 0:(_ticket$contact=ticket.contact)===null||_ticket$contact===void 0?void 0:(_ticket$contact$name=_ticket$contact.name)===null||_ticket$contact$name===void 0?void 0:_ticket$contact$name.length)>30?(ticket===null||ticket===void 0?void 0:(_ticket$contact2=ticket.contact)===null||_ticket$contact2===void 0?void 0:_ticket$contact2.name.substring(0,25))+'...':ticket===null||ticket===void 0?void 0:(_ticket$contact3=ticket.contact)===null||_ticket$contact3===void 0?void 0:_ticket$contact3.name,secondary:/*#__PURE__*/React.createElement(Fragment,null,/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Typography,{style:{display:'inline'},component:\"span\",variant:\"body2\"},\"\".concat(((_ticket$lastMessage=ticket.lastMessage)===null||_ticket$lastMessage===void 0?void 0:_ticket$lastMessage.length)>30?String(ticket.lastMessage).substring(0,27)+'...':ticket.lastMessage))),/*#__PURE__*/React.createElement(Badge,{className:classes.connectionTag},ticket===null||ticket===void 0?void 0:(_ticket$whatsapp=ticket.whatsapp)===null||_ticket$whatsapp===void 0?void 0:_ticket$whatsapp.name),/*#__PURE__*/React.createElement(Badge,{style:{backgroundColor:((_ticket$queue=ticket.queue)===null||_ticket$queue===void 0?void 0:_ticket$queue.color)||\"#7c7c7c\"},className:classes.connectionTag},((_ticket$queue2=ticket.queue)===null||_ticket$queue2===void 0?void 0:_ticket$queue2.name.toUpperCase())||\"SEM FILA\"))}),/*#__PURE__*/React.createElement(Typography,{className:Number(ticket.unreadMessages)>0?classes.lastMessageTimeUnread:classes.lastMessageTime,component:\"span\",variant:\"body2\"},isSameDay(parseISO(ticket.updatedAt),new Date())?/*#__PURE__*/React.createElement(React.Fragment,null,format(parseISO(ticket.updatedAt),\"HH:mm\")):/*#__PURE__*/React.createElement(React.Fragment,null,format(parseISO(ticket.updatedAt),\"dd/MM/yyyy\"))),(user.profile===\"admin\"||ticket.userId===user.id)&&/*#__PURE__*/React.createElement(Tooltip,{title:\"Acessar Ticket\"},/*#__PURE__*/React.createElement(VisibilityOutlined,{onClick:()=>history.push(\"/tickets/\".concat(ticket.uuid)),fontSize:\"small\",style:{color:grey[500],cursor:\"pointer\",marginRight:5,bottom:\"-15px\"}}))),/*#__PURE__*/React.createElement(Divider,{variant:\"inset\",component:\"li\"}));})))));});}else{return null;}},[update]);const MomentsPending=useMemo(()=>{if(tickets&&tickets.length>0){const pendingTickets=tickets.filter(ticket=>!ticket.user);return/*#__PURE__*/React.createElement(Grid,{item:true},/*#__PURE__*/React.createElement(\"div\",{className:classes.main},/*#__PURE__*/React.createElement(\"div\",{padding:2,className:classes.changeWarap},/*#__PURE__*/React.createElement(Paper,{elevation:3,className:classes.cardHeaderPending},/*#__PURE__*/React.createElement(CardHeader,{style:{maxWidth:'380px',width:'100%'},avatar:/*#__PURE__*/React.createElement(Avatar,null),title:/*#__PURE__*/React.createElement(\"span\",null,\"Pendentes\",/*#__PURE__*/React.createElement(ReportProblem,{className:classes.pending}),/*#__PURE__*/React.createElement(\"div\",null,\"Atendimentos: \",pendingTickets===null||pendingTickets===void 0?void 0:pendingTickets.length))})),/*#__PURE__*/React.createElement(Paper,{square:true,elevation:1,className:classes.card},pendingTickets.map(ticket=>{var _ticket$contact4,_ticket$lastMessage2,_ticket$whatsapp2,_ticket$queue3,_ticket$queue4;return/*#__PURE__*/React.createElement(List,{style:{paddingTop:0},key:ticket.id},/*#__PURE__*/React.createElement(ListItem,{dense:true,button:true},/*#__PURE__*/React.createElement(ListItemAvatar,null,/*#__PURE__*/React.createElement(Avatar,{alt:\"\".concat(ticket.contact.urlPicture),src:\"\".concat(ticket.contact.urlPicture)})),/*#__PURE__*/React.createElement(ListItemText,{disableTypography:true,primary:ticket===null||ticket===void 0?void 0:(_ticket$contact4=ticket.contact)===null||_ticket$contact4===void 0?void 0:_ticket$contact4.name,secondary:/*#__PURE__*/React.createElement(Fragment,null,/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Typography,{style:{display:'inline'},component:\"span\",variant:\"body2\"},\"\".concat(((_ticket$lastMessage2=ticket.lastMessage)===null||_ticket$lastMessage2===void 0?void 0:_ticket$lastMessage2.length)>30?String(ticket.lastMessage).substring(0,27)+'...':ticket.lastMessage))),/*#__PURE__*/React.createElement(Badge,{className:classes.connectionTag},ticket===null||ticket===void 0?void 0:(_ticket$whatsapp2=ticket.whatsapp)===null||_ticket$whatsapp2===void 0?void 0:_ticket$whatsapp2.name),/*#__PURE__*/React.createElement(Badge,{style:{backgroundColor:((_ticket$queue3=ticket.queue)===null||_ticket$queue3===void 0?void 0:_ticket$queue3.color)||\"#7c7c7c\"},className:classes.connectionTag},((_ticket$queue4=ticket.queue)===null||_ticket$queue4===void 0?void 0:_ticket$queue4.name.toUpperCase())||\"SEM FILA\"))}),/*#__PURE__*/React.createElement(Typography,{className:Number(ticket.unreadMessages)>0?classes.lastMessageTimeUnread:classes.lastMessageTime,component:\"span\",variant:\"body2\"},isSameDay(parseISO(ticket.updatedAt),new Date())?/*#__PURE__*/React.createElement(React.Fragment,null,format(parseISO(ticket.updatedAt),\"HH:mm\")):/*#__PURE__*/React.createElement(React.Fragment,null,format(parseISO(ticket.updatedAt),\"dd/MM/yyyy\")))),/*#__PURE__*/React.createElement(Divider,{variant:\"inset\",component:\"li\"}));})))));}else{return null;}},[update]);return/*#__PURE__*/React.createElement(Fragment,null,/*#__PURE__*/React.createElement(Grid,{container:true,spacing:2},Moments,MomentsPending));};export default DashboardManage;","map":null,"metadata":{},"sourceType":"module"}