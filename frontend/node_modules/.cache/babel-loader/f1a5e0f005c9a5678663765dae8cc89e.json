{"ast":null,"code":"import React,{useState,useEffect,useReducer,useCallback,useContext}from\"react\";import{toast}from\"react-toastify\";import{useHistory}from\"react-router-dom\";import{makeStyles}from\"@material-ui/core/styles\";import Paper from\"@material-ui/core/Paper\";import Button from\"@material-ui/core/Button\";import TextField from\"@material-ui/core/TextField\";import InputAdornment from\"@material-ui/core/InputAdornment\";import MainContainer from\"../../components/MainContainer\";import MainHeader from\"../../components/MainHeader\";import Title from\"../../components/Title\";import api from\"../../services/api\";import{i18n}from\"../../translate/i18n\";import MainHeaderButtonsWrapper from\"../../components/MainHeaderButtonsWrapper\";// import MessageModal from \"../../components/MessageModal\"\nimport ScheduleModal from\"../../components/ScheduleModal\";import ConfirmationModal from\"../../components/ConfirmationModal\";import toastError from\"../../errors/toastError\";import moment from\"moment\";// import { SocketContext } from \"../../context/Socket/SocketContext\";\nimport{AuthContext}from\"../../context/Auth/AuthContext\";import usePlans from\"../../hooks/usePlans\";import{Calendar,momentLocalizer}from\"react-big-calendar\";import\"moment/locale/pt-br\";import\"react-big-calendar/lib/css/react-big-calendar.css\";import SearchIcon from\"@material-ui/icons/Search\";import DeleteOutlineIcon from\"@material-ui/icons/DeleteOutline\";import EditIcon from\"@material-ui/icons/Edit\";import\"./Schedules.css\";// Importe o arquivo CSS\n// Defina a função getUrlParam antes de usá-la\nfunction getUrlParam(paramName){const searchParams=new URLSearchParams(window.location.search);return searchParams.get(paramName);}const eventTitleStyle={fontSize:\"14px\",// Defina um tamanho de fonte menor\noverflow:\"hidden\",// Oculte qualquer conteúdo excedente\nwhiteSpace:\"nowrap\",// Evite a quebra de linha do texto\ntextOverflow:\"ellipsis\"// Exiba \"...\" se o texto for muito longo\n};const localizer=momentLocalizer(moment);var defaultMessages={date:\"Data\",time:\"Hora\",event:\"Evento\",allDay:\"Dia Todo\",week:\"Semana\",work_week:\"Agendamentos\",day:\"Dia\",month:\"Mês\",previous:\"Anterior\",next:\"Próximo\",yesterday:\"Ontem\",tomorrow:\"Amanhã\",today:\"Hoje\",agenda:\"Agenda\",noEventsInRange:\"Não há agendamentos no período.\",showMore:function showMore(total){return\"+\"+total+\" mais\";}};const reducer=(state,action)=>{if(action.type===\"LOAD_SCHEDULES\"){const schedules=action.payload;const newSchedules=[];schedules.forEach(schedule=>{const scheduleIndex=state.findIndex(s=>s.id===schedule.id);if(scheduleIndex!==-1){state[scheduleIndex]=schedule;}else{newSchedules.push(schedule);}});return[...state,...newSchedules];}if(action.type===\"UPDATE_SCHEDULES\"){const schedule=action.payload;const scheduleIndex=state.findIndex(s=>s.id===schedule.id);if(scheduleIndex!==-1){state[scheduleIndex]=schedule;return[...state];}else{return[schedule,...state];}}if(action.type===\"DELETE_SCHEDULE\"){const scheduleId=action.payload;const scheduleIndex=state.findIndex(s=>s.id===scheduleId);if(scheduleIndex!==-1){state.splice(scheduleIndex,1);}return[...state];}if(action.type===\"RESET\"){return[];}};const useStyles=makeStyles(theme=>({mainPaper:{flex:1,padding:theme.spacing(1),overflowY:\"scroll\",...theme.scrollbarStyles},calendarToolbar:{'& .rbc-toolbar-label':{color:theme.mode===\"light\"?theme.palette.light:\"white\"},'& .rbc-btn-group button':{color:theme.mode===\"light\"?theme.palette.light:\"white\",'&:hover':{color:theme.palette.mode==='dark'?'#fff':'#000'},'&:active':{color:theme.palette.mode==='dark'?'#fff':'#000'},'&:focus':{color:theme.palette.mode==='dark'?'#fff':'#000'},'&.rbc-active':{color:theme.palette.mode==='dark'?'#fff':'#000'}}}}));const Schedules=()=>{const classes=useStyles();const history=useHistory();//   const socketManager = useContext(SocketContext);\nconst{user,socket}=useContext(AuthContext);const[loading,setLoading]=useState(false);const[pageNumber,setPageNumber]=useState(1);const[hasMore,setHasMore]=useState(false);const[selectedSchedule,setSelectedSchedule]=useState(null);const[deletingSchedule,setDeletingSchedule]=useState(null);const[confirmModalOpen,setConfirmModalOpen]=useState(false);const[searchParam,setSearchParam]=useState(\"\");const[schedules,dispatch]=useReducer(reducer,[]);const[scheduleModalOpen,setScheduleModalOpen]=useState(false);const[contactId,setContactId]=useState(+getUrlParam(\"contactId\"));const{getPlanCompany}=usePlans();useEffect(()=>{async function fetchData(){const companyId=user.companyId;const planConfigs=await getPlanCompany(undefined,companyId);if(!planConfigs.plan.useSchedules){toast.error(\"Esta empresa não possui permissão para acessar essa página! Estamos lhe redirecionando.\");setTimeout(()=>{history.push(\"/\");},1000);}}fetchData();},[user,history,getPlanCompany]);const fetchSchedules=useCallback(async()=>{try{const{data}=await api.get(\"/schedules\",{params:{searchParam,pageNumber}});dispatch({type:\"LOAD_SCHEDULES\",payload:data.schedules});setHasMore(data.hasMore);setLoading(false);}catch(err){toastError(err);}},[searchParam,pageNumber]);const handleOpenScheduleModalFromContactId=useCallback(()=>{if(contactId){handleOpenScheduleModal();}},[contactId]);useEffect(()=>{dispatch({type:\"RESET\"});setPageNumber(1);},[searchParam]);useEffect(()=>{setLoading(true);const delayDebounceFn=setTimeout(()=>{fetchSchedules();},500);return()=>clearTimeout(delayDebounceFn);},[searchParam,pageNumber,contactId,fetchSchedules,handleOpenScheduleModalFromContactId]);useEffect(()=>{// handleOpenScheduleModalFromContactId();\n// const socket = socketManager.GetSocket(user.companyId, user.id);\nconst onCompanySchedule=data=>{if(data.action===\"update\"||data.action===\"create\"){dispatch({type:\"UPDATE_SCHEDULES\",payload:data.schedule});}if(data.action===\"delete\"){dispatch({type:\"DELETE_SCHEDULE\",payload:+data.scheduleId});}};socket.on(\"company\".concat(user.companyId,\"-schedule\"),onCompanySchedule);return()=>{socket.off(\"company\".concat(user.companyId,\"-schedule\"),onCompanySchedule);};},[socket]);const cleanContact=()=>{setContactId(\"\");};const handleOpenScheduleModal=()=>{setSelectedSchedule(null);setScheduleModalOpen(true);};const handleCloseScheduleModal=()=>{setSelectedSchedule(null);setScheduleModalOpen(false);};const handleSearch=event=>{setSearchParam(event.target.value.toLowerCase());};const handleEditSchedule=schedule=>{setSelectedSchedule(schedule);setScheduleModalOpen(true);};const handleDeleteSchedule=async scheduleId=>{try{await api.delete(\"/schedules/\".concat(scheduleId));toast.success(i18n.t(\"schedules.toasts.deleted\"));}catch(err){toastError(err);}setDeletingSchedule(null);setSearchParam(\"\");setPageNumber(1);dispatch({type:\"RESET\"});setPageNumber(1);await fetchSchedules();};const loadMore=()=>{setPageNumber(prevState=>prevState+1);};const handleScroll=e=>{if(!hasMore||loading)return;const{scrollTop,scrollHeight,clientHeight}=e.currentTarget;if(scrollHeight-(scrollTop+100)<clientHeight){loadMore();}};const truncate=(str,len)=>{if(str.length>len){return str.substring(0,len)+\"...\";}return str;};return/*#__PURE__*/React.createElement(MainContainer,null,/*#__PURE__*/React.createElement(ConfirmationModal,{title:deletingSchedule&&\"\".concat(i18n.t(\"schedules.confirmationModal.deleteTitle\")),open:confirmModalOpen,onClose:()=>setConfirmModalOpen(false),onConfirm:()=>handleDeleteSchedule(deletingSchedule.id)},i18n.t(\"schedules.confirmationModal.deleteMessage\")),scheduleModalOpen&&/*#__PURE__*/React.createElement(ScheduleModal,{open:scheduleModalOpen,onClose:handleCloseScheduleModal,reload:fetchSchedules// aria-labelledby=\"form-dialog-title\"\n,scheduleId:selectedSchedule?selectedSchedule.id:null,contactId:contactId,cleanContact:cleanContact}),/*#__PURE__*/React.createElement(MainHeader,null,/*#__PURE__*/React.createElement(Title,null,i18n.t(\"schedules.title\"),\" (\",schedules.length,\")\"),/*#__PURE__*/React.createElement(MainHeaderButtonsWrapper,null,/*#__PURE__*/React.createElement(TextField,{placeholder:i18n.t(\"contacts.searchPlaceholder\"),type:\"search\",value:searchParam,onChange:handleSearch,InputProps:{startAdornment:/*#__PURE__*/React.createElement(InputAdornment,{position:\"start\"},/*#__PURE__*/React.createElement(SearchIcon,{style:{color:\"gray\"}}))}}),/*#__PURE__*/React.createElement(Button,{variant:\"contained\",color:\"primary\",onClick:handleOpenScheduleModal},i18n.t(\"schedules.buttons.add\")))),/*#__PURE__*/React.createElement(Paper,{className:classes.mainPaper,variant:\"outlined\",onScroll:handleScroll},/*#__PURE__*/React.createElement(Calendar,{messages:defaultMessages,formats:{agendaDateFormat:\"DD/MM ddd\",weekdayFormat:\"dddd\"},localizer:localizer,events:schedules.map(schedule=>{var _schedule$contact;return{title:/*#__PURE__*/React.createElement(\"div\",{key:schedule.id,className:\"event-container\"},/*#__PURE__*/React.createElement(\"div\",{style:eventTitleStyle},schedule===null||schedule===void 0?void 0:(_schedule$contact=schedule.contact)===null||_schedule$contact===void 0?void 0:_schedule$contact.name),/*#__PURE__*/React.createElement(DeleteOutlineIcon,{onClick:()=>handleDeleteSchedule(schedule.id),className:\"delete-icon\"}),/*#__PURE__*/React.createElement(EditIcon,{onClick:()=>{handleEditSchedule(schedule);setScheduleModalOpen(true);},className:\"edit-icon\"})),start:new Date(schedule.sendAt),end:new Date(schedule.sendAt)};}),startAccessor:\"start\",endAccessor:\"end\",style:{height:500},className:classes.calendarToolbar})));};export default Schedules;","map":null,"metadata":{},"sourceType":"module"}