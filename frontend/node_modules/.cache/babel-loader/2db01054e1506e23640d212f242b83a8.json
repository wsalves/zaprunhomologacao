{"ast":null,"code":"import React,{useState,useEffect,useContext,useRef}from\"react\";import*as Yup from\"yup\";import{Formik,Form,Field}from\"formik\";import{toast}from\"react-toastify\";import{makeStyles}from\"@material-ui/core/styles\";import{green}from\"@material-ui/core/colors\";import Button from\"@material-ui/core/Button\";import TextField from\"@material-ui/core/TextField\";import Dialog from\"@material-ui/core/Dialog\";import DialogActions from\"@material-ui/core/DialogActions\";import DialogContent from\"@material-ui/core/DialogContent\";import DialogTitle from\"@material-ui/core/DialogTitle\";import CircularProgress from\"@material-ui/core/CircularProgress\";import Select from\"@material-ui/core/Select\";import InputLabel from\"@material-ui/core/InputLabel\";import MenuItem from\"@material-ui/core/MenuItem\";import FormControl from\"@material-ui/core/FormControl\";import whatsappIcon from'../../assets/nopicture.png';import{i18n}from\"../../translate/i18n\";import api from\"../../services/api\";import toastError from\"../../errors/toastError\";import QueueSelect from\"../QueueSelect\";import{AuthContext}from\"../../context/Auth/AuthContext\";import useWhatsApps from\"../../hooks/useWhatsApps\";import{Can}from\"../Can\";import{Avatar,Grid,Input,Paper,Tab,Tabs}from\"@material-ui/core\";import{getBackendUrl}from\"../../config\";import TabPanel from\"../TabPanel\";import AvatarUploader from\"../AvatarUpload\";const backendUrl=getBackendUrl();const path=require('path');const useStyles=makeStyles(theme=>({root:{display:\"flex\",flexWrap:\"wrap\"},multFieldLine:{display:\"flex\",\"& > *:not(:last-child)\":{marginRight:theme.spacing(1)}},btnWrapper:{position:\"relative\"},buttonProgress:{color:green[500],position:\"absolute\",top:\"50%\",left:\"50%\",marginTop:-12,marginLeft:-12},formControl:{margin:theme.spacing(1),minWidth:120},textField:{marginRight:theme.spacing(1),flex:1},container:{display:'flex',flexWrap:'wrap'},avatar:{width:theme.spacing(12),height:theme.spacing(12),margin:theme.spacing(2),cursor:'pointer',borderRadius:'50%',border:'2px solid #ccc'},updateDiv:{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center'},updateInput:{display:'none'},updateLabel:{padding:theme.spacing(1),margin:theme.spacing(1),textTransform:'uppercase',textAlign:'center',cursor:'pointer',border:'2px solid #ccc',borderRadius:'5px',minWidth:160,fontWeight:'bold',color:'#555'},errorUpdate:{border:'2px solid red'},errorText:{color:'red',fontSize:'0.8rem',fontWeight:'bold'}}));const UserSchema=Yup.object().shape({name:Yup.string().min(2,\"Too Short!\").max(50,\"Too Long!\").required(\"Required\"),password:Yup.string().min(5,\"Too Short!\").max(50,\"Too Long!\"),email:Yup.string().email(\"Invalid email\").required(\"Required\"),allHistoric:Yup.string().nullable()});const UserModal=_ref=>{let{open,onClose,userId}=_ref;const classes=useStyles();const initialState={name:\"\",email:\"\",password:\"\",profile:\"user\",startWork:\"00:00\",endWork:\"23:59\",farewellMessage:\"\",allTicket:\"disable\",allowGroup:false,defaultTheme:\"light\",defaultMenu:\"open\",allHistoric:\"disabled\",allUserChat:\"disabled\",userClosePendingTicket:\"enabled\",showDashboard:\"disabled\",allowRealTime:\"disabled\",allowConnections:\"disabled\"};const{user:loggedInUser}=useContext(AuthContext);const[user,setUser]=useState(initialState);const[selectedQueueIds,setSelectedQueueIds]=useState([]);const[whatsappId,setWhatsappId]=useState(false);// const [allTicket, setAllTicket] = useState(\"disable\");\nconst{loading,whatsApps}=useWhatsApps();const[profileUrl,setProfileUrl]=useState(null);const[tab,setTab]=useState(\"general\");const[avatar,setAvatar]=useState(null);const startWorkRef=useRef();const endWorkRef=useRef();useEffect(()=>{const fetchUser=async()=>{if(!userId)return;try{var _data$queues;const{data}=await api.get(\"/users/\".concat(userId));setUser(prevState=>{return{...prevState,...data};});const{profileImage}=data;setProfileUrl(\"\".concat(backendUrl,\"/public/company\").concat(data.companyId,\"/user/\").concat(profileImage));const userQueueIds=(_data$queues=data.queues)===null||_data$queues===void 0?void 0:_data$queues.map(queue=>queue.id);setSelectedQueueIds(userQueueIds);setWhatsappId(data.whatsappId?data.whatsappId:'');}catch(err){toastError(err);}};fetchUser();},[userId,open]);const handleClose=()=>{onClose();setUser(initialState);};const handleTabChange=(event,newValue)=>{setTab(newValue);};const handleSaveUser=async values=>{const uploadAvatar=async file=>{const formData=new FormData();formData.append('userId',file.id);formData.append('typeArch',\"user\");formData.append('profileImage',avatar);const{data}=await api.post(\"/users/\".concat(file.id,\"/media-upload\"),formData);localStorage.setItem(\"profileImage\",data.user.profileImage);};const userData={...values,whatsappId,queueIds:selectedQueueIds};try{if(userId){const{data}=await api.put(\"/users/\".concat(userId),userData);if(avatar&&(!(user===null||user===void 0?void 0:user.profileImage)||!(user===null||user===void 0?void 0:user.profileImage)!==avatar.name))// getBasename(avatar)))\nuploadAvatar(data);}else{await api.post(\"/users\",userData);if(!(user===null||user===void 0?void 0:user.profileImage)&&avatar)uploadAvatar(user);}if(userId===loggedInUser.id){handleClose();toast.success(i18n.t(\"userModal.success\"));window.location.reload();}else{handleClose();toast.success(i18n.t(\"userModal.success\"));}}catch(err){toastError(err);}};return/*#__PURE__*/React.createElement(\"div\",{className:classes.root},/*#__PURE__*/React.createElement(Dialog,{open:open,onClose:handleClose,maxWidth:\"sm\",fullWidth:true,scroll:\"paper\"},/*#__PURE__*/React.createElement(DialogTitle,{id:\"form-dialog-title\"},userId?\"\".concat(i18n.t(\"userModal.title.edit\")):\"\".concat(i18n.t(\"userModal.title.add\"))),/*#__PURE__*/React.createElement(Formik,{initialValues:user,enableReinitialize:true,validationSchema:UserSchema,onSubmit:(values,actions)=>{setTimeout(()=>{handleSaveUser(values);actions.setSubmitting(false);},400);}},_ref2=>{let{touched,errors,isSubmitting,setFieldValue}=_ref2;return/*#__PURE__*/React.createElement(Form,null,/*#__PURE__*/React.createElement(Paper,{className:classes.mainPaper,elevation:1},/*#__PURE__*/React.createElement(Tabs,{value:tab,indicatorColor:\"primary\",textColor:\"primary\",scrollButtons:\"on\",variant:\"scrollable\",onChange:handleTabChange,className:classes.tab},/*#__PURE__*/React.createElement(Tab,{label:i18n.t(\"userModal.tabs.general\"),value:\"general\"}),/*#__PURE__*/React.createElement(Tab,{label:i18n.t(\"userModal.tabs.permissions\"),value:\"permissions\"}))),/*#__PURE__*/React.createElement(Paper,{className:classes.paper,elevation:0},/*#__PURE__*/React.createElement(DialogContent,{dividers:true},/*#__PURE__*/React.createElement(TabPanel,{className:classes.container,value:tab,name:\"general\"},/*#__PURE__*/React.createElement(Grid,{container:true,spacing:1,alignContent:\"center\",alignItems:\"center\",justifyContent:\"center\"},/*#__PURE__*/React.createElement(FormControl,{className:classes.updateDiv},/*#__PURE__*/React.createElement(AvatarUploader,{setAvatar:setAvatar,avatar:user.profileImage,companyId:user.companyId}),user.profileImage&&/*#__PURE__*/React.createElement(Button,{variant:\"outlined\",color:\"secondary\",onClick:()=>{user.profileImage=null;setFieldValue(\"profileImage\",null);setAvatar(null);}},i18n.t(\"userModal.title.removeImage\")))),/*#__PURE__*/React.createElement(Grid,{container:true,spacing:1},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"userModal.form.name\"),autoFocus:true,name:\"name\",error:touched.name&&Boolean(errors.name),helperText:touched.name&&errors.name,variant:\"outlined\",margin:\"dense\",fullWidth:true})),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"userModal.form.password\"),type:\"password\",name:\"password\",error:touched.password&&Boolean(errors.password),helperText:touched.password&&errors.password,variant:\"outlined\",margin:\"dense\",fullWidth:true}))),/*#__PURE__*/React.createElement(Grid,{container:true,spacing:1},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:8,xl:8},/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"userModal.form.email\"),name:\"email\",error:touched.email&&Boolean(errors.email),helperText:touched.email&&errors.email,variant:\"outlined\",margin:\"dense\",fullWidth:true})),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:4,xl:4},/*#__PURE__*/React.createElement(FormControl,{variant:\"outlined\"//className={classes.formControl}\n,margin:\"dense\",fullWidth:true},/*#__PURE__*/React.createElement(Can,{role:loggedInUser.profile,perform:\"user-modal:editProfile\",yes:()=>/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(InputLabel,{id:\"profile-selection-input-label\"},i18n.t(\"userModal.form.profile\")),/*#__PURE__*/React.createElement(Field,{as:Select,label:i18n.t(\"userModal.form.profile\"),name:\"profile\",labelId:\"profile-selection-label\",id:\"profile-selection\",required:true},/*#__PURE__*/React.createElement(MenuItem,{value:\"admin\"},\"Admin\"),/*#__PURE__*/React.createElement(MenuItem,{value:\"user\"},\"User\")))})))),/*#__PURE__*/React.createElement(Grid,{container:true,spacing:1},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:12,xl:12},/*#__PURE__*/React.createElement(Can,{role:loggedInUser.profile,perform:\"user-modal:editQueues\",yes:()=>/*#__PURE__*/React.createElement(QueueSelect,{selectedQueueIds:selectedQueueIds,onChange:values=>setSelectedQueueIds(values),fullWidth:true})}))),/*#__PURE__*/React.createElement(Grid,{container:true,spacing:1},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:12,xl:12},/*#__PURE__*/React.createElement(Can,{role:loggedInUser.profile,perform:\"user-modal:editProfile\",yes:()=>/*#__PURE__*/React.createElement(FormControl,{variant:\"outlined\",margin:\"dense\",className:classes.maxWidth,fullWidth:true},/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"userModal.form.whatsapp\")),/*#__PURE__*/React.createElement(Field,{as:Select,value:whatsappId,onChange:e=>setWhatsappId(e.target.value),label:i18n.t(\"userModal.form.whatsapp\")},/*#__PURE__*/React.createElement(MenuItem,{value:''},\"\\xA0\"),whatsApps.map(whatsapp=>/*#__PURE__*/React.createElement(MenuItem,{key:whatsapp.id,value:whatsapp.id},whatsapp.name))))}))),/*#__PURE__*/React.createElement(Can,{role:loggedInUser.profile,perform:\"user-modal:editProfile\",yes:()=>/*#__PURE__*/React.createElement(Grid,{container:true,spacing:1},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"userModal.form.startWork\"),type:\"time\",ampm:\"false\",inputRef:startWorkRef,InputLabelProps:{shrink:true},inputProps:{step:600// 5 min\n},fullWidth:true,name:\"startWork\",error:touched.startWork&&Boolean(errors.startWork),helperText:touched.startWork&&errors.startWork,variant:\"outlined\",margin:\"dense\",className:classes.textField})),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"userModal.form.endWork\"),type:\"time\",ampm:\"false\",inputRef:endWorkRef,InputLabelProps:{shrink:true},inputProps:{step:600// 5 min\n},fullWidth:true,name:\"endWork\",error:touched.endWork&&Boolean(errors.endWork),helperText:touched.endWork&&errors.endWork,variant:\"outlined\",margin:\"dense\",className:classes.textField})))}),/*#__PURE__*/React.createElement(Field,{as:TextField,label:i18n.t(\"userModal.form.farewellMessage\"),type:\"farewellMessage\",multiline:true,rows:4,fullWidth:true,name:\"farewellMessage\",error:touched.farewellMessage&&Boolean(errors.farewellMessage),helperText:touched.farewellMessage&&errors.farewellMessage,variant:\"outlined\",margin:\"dense\"}),/*#__PURE__*/React.createElement(Grid,{container:true,spacing:1},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(FormControl,{variant:\"outlined\",className:classes.maxWidth,margin:\"dense\",fullWidth:true},/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"userModal.form.defaultTheme\")),/*#__PURE__*/React.createElement(Field,{as:Select,label:i18n.t(\"userModal.form.defaultTheme\"),name:\"defaultTheme\",type:\"defaultTheme\",required:true},/*#__PURE__*/React.createElement(MenuItem,{value:\"light\"},i18n.t(\"userModal.form.defaultThemeLight\")),/*#__PURE__*/React.createElement(MenuItem,{value:\"dark\"},i18n.t(\"userModal.form.defaultThemeDark\")))))),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(FormControl,{variant:\"outlined\",className:classes.maxWidth,margin:\"dense\",fullWidth:true},/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"userModal.form.defaultMenu\")),/*#__PURE__*/React.createElement(Field,{as:Select,label:i18n.t(\"userModal.form.defaultMenu\"),name:\"defaultMenu\",type:\"defaultMenu\",required:true},/*#__PURE__*/React.createElement(MenuItem,{value:\"open\"},i18n.t(\"userModal.form.defaultMenuOpen\")),/*#__PURE__*/React.createElement(MenuItem,{value:\"closed\"},i18n.t(\"userModal.form.defaultMenuClosed\")))))))),/*#__PURE__*/React.createElement(TabPanel,{className:classes.container,value:tab,name:\"permissions\"},/*#__PURE__*/React.createElement(Can,{role:loggedInUser.profile,perform:\"user-modal:editProfile\",yes:()=>/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(Grid,{container:true,spacing:1},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(FormControl,{variant:\"outlined\",className:classes.maxWidth,margin:\"dense\",fullWidth:true},/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"userModal.form.allTicket\")),/*#__PURE__*/React.createElement(Field,{as:Select,label:i18n.t(\"userModal.form.allTicket\"),name:\"allTicket\",type:\"allTicket\",required:true},/*#__PURE__*/React.createElement(MenuItem,{value:\"enable\"},i18n.t(\"userModal.form.allTicketEnable\")),/*#__PURE__*/React.createElement(MenuItem,{value:\"disable\"},i18n.t(\"userModal.form.allTicketDisable\")))))),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(FormControl,{variant:\"outlined\",className:classes.maxWidth,margin:\"dense\",fullWidth:true},/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"userModal.form.allowGroup\")),/*#__PURE__*/React.createElement(Field,{as:Select,label:i18n.t(\"userModal.form.allowGroup\"),name:\"allowGroup\",type:\"allowGroup\",required:true},/*#__PURE__*/React.createElement(MenuItem,{value:true},i18n.t(\"userModal.form.allTicketEnable\")),/*#__PURE__*/React.createElement(MenuItem,{value:false},i18n.t(\"userModal.form.allTicketDisable\"))))))),/*#__PURE__*/React.createElement(Grid,{container:true,spacing:1},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(FormControl,{variant:\"outlined\",className:classes.maxWidth,margin:\"dense\",fullWidth:true},/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"userModal.form.allHistoric\")),/*#__PURE__*/React.createElement(Field,{as:Select,label:i18n.t(\"userModal.form.allHistoric\"),name:\"allHistoric\",type:\"allHistoric\",required:true},/*#__PURE__*/React.createElement(MenuItem,{value:\"disabled\"},i18n.t(\"userModal.form.allHistoricDisabled\")),/*#__PURE__*/React.createElement(MenuItem,{value:\"enabled\"},i18n.t(\"userModal.form.allHistoricEnabled\")))))),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(FormControl,{variant:\"outlined\",className:classes.maxWidth,margin:\"dense\",fullWidth:true},/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"userModal.form.allUserChat\")),/*#__PURE__*/React.createElement(Field,{as:Select,label:i18n.t(\"userModal.form.allUserChat\"),name:\"allUserChat\",type:\"allUserChat\",required:true},/*#__PURE__*/React.createElement(MenuItem,{value:\"disabled\"},i18n.t(\"userModal.form.allHistoricDisabled\")),/*#__PURE__*/React.createElement(MenuItem,{value:\"enabled\"},i18n.t(\"userModal.form.allHistoricEnabled\"))))))),/*#__PURE__*/React.createElement(Grid,{container:true,spacing:1},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(FormControl,{variant:\"outlined\",className:classes.maxWidth,margin:\"dense\",fullWidth:true},/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"userModal.form.userClosePendingTicket\")),/*#__PURE__*/React.createElement(Field,{as:Select,label:i18n.t(\"userModal.form.userClosePendingTicket\"),name:\"userClosePendingTicket\",type:\"userClosePendingTicket\",required:true},/*#__PURE__*/React.createElement(MenuItem,{value:\"disabled\"},i18n.t(\"userModal.form.allHistoricDisabled\")),/*#__PURE__*/React.createElement(MenuItem,{value:\"enabled\"},i18n.t(\"userModal.form.allHistoricEnabled\")))))),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(FormControl,{variant:\"outlined\",className:classes.maxWidth,margin:\"dense\",fullWidth:true},/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"userModal.form.allowConnections\")),/*#__PURE__*/React.createElement(Field,{as:Select,label:i18n.t(\"userModal.form.allowConnections\"),name:\"allowConnections\",type:\"allowConnections\",required:true},/*#__PURE__*/React.createElement(MenuItem,{value:\"disabled\"},i18n.t(\"userModal.form.allHistoricDisabled\")),/*#__PURE__*/React.createElement(MenuItem,{value:\"enabled\"},i18n.t(\"userModal.form.allHistoricEnabled\"))))))),/*#__PURE__*/React.createElement(Grid,{container:true,spacing:1},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(FormControl,{variant:\"outlined\",className:classes.maxWidth,margin:\"dense\",fullWidth:true},/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"userModal.form.showDashboard\")),/*#__PURE__*/React.createElement(Field,{as:Select,label:i18n.t(\"userModal.form.showDashboard\"),name:\"showDashboard\",type:\"showDashboard\",required:true},/*#__PURE__*/React.createElement(MenuItem,{value:\"disabled\"},i18n.t(\"userModal.form.allHistoricDisabled\")),/*#__PURE__*/React.createElement(MenuItem,{value:\"enabled\"},i18n.t(\"userModal.form.allHistoricEnabled\")))))),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:6,xl:6},/*#__PURE__*/React.createElement(FormControl,{variant:\"outlined\",className:classes.maxWidth,margin:\"dense\",fullWidth:true},/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"userModal.form.allowRealTime\")),/*#__PURE__*/React.createElement(Field,{as:Select,label:i18n.t(\"userModal.form.allowRealTime\"),name:\"allowRealTime\",type:\"allowRealTime\",required:true},/*#__PURE__*/React.createElement(MenuItem,{value:\"disabled\"},i18n.t(\"userModal.form.allHistoricDisabled\")),/*#__PURE__*/React.createElement(MenuItem,{value:\"enabled\"},i18n.t(\"userModal.form.allHistoricEnabled\"))))))))})))),/*#__PURE__*/React.createElement(DialogActions,null,/*#__PURE__*/React.createElement(Button,{onClick:handleClose,color:\"secondary\",disabled:isSubmitting,variant:\"outlined\"},i18n.t(\"userModal.buttons.cancel\")),/*#__PURE__*/React.createElement(Button,{type:\"submit\",color:\"primary\",disabled:isSubmitting,variant:\"contained\",className:classes.btnWrapper},userId?\"\".concat(i18n.t(\"userModal.buttons.okEdit\")):\"\".concat(i18n.t(\"userModal.buttons.okAdd\")),isSubmitting&&/*#__PURE__*/React.createElement(CircularProgress,{size:24,className:classes.buttonProgress}))));})));};export default UserModal;","map":null,"metadata":{},"sourceType":"module"}