{"ast":null,"code":"import React,{useState,useEffect,useRef,useContext,useCallback}from\"react\";import{useHistory,useParams}from\"react-router-dom\";import{parseISO,format,isSameDay}from\"date-fns\";import clsx from\"clsx\";import{makeStyles,useTheme}from\"@material-ui/core/styles\";import{green,grey}from\"@material-ui/core/colors\";import{i18n}from\"../../translate/i18n\";import api from\"../../services/api\";import ButtonWithSpinner from\"../ButtonWithSpinner\";import MarkdownWrapper from\"../MarkdownWrapper\";import{List,Tooltip}from\"@material-ui/core\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{TicketsContext}from\"../../context/Tickets/TicketsContext\";import toastError from\"../../errors/toastError\";import{v4 as uuidv4}from\"uuid\";import GroupIcon from'@material-ui/icons/Group';import ContactTag from\"../ContactTag\";import ConnectionIcon from\"../ConnectionIcon\";import AcceptTicketWithouSelectQueue from\"../AcceptTicketWithoutQueueModal\";import TransferTicketModalCustom from\"../TransferTicketModalCustom\";import ShowTicketOpen from\"../ShowTicketOpenModal\";import{isNil}from\"lodash\";import{toast}from\"react-toastify\";import{Done,HighlightOff,Replay,SwapHoriz}from\"@material-ui/icons\";import useCompanySettings from\"../../hooks/useSettings/companySettings\";import{Avatar,Badge,ListItemAvatar,ListItem,ListItemSecondaryAction,ListItemText,Typography}from\"@material-ui/core\";const useStyles=makeStyles(theme=>({ticket:{position:\"relative\"},pendingTicket:{cursor:\"unset\"},queueTag:{background:\"#FCFCFC\",color:\"#000\",marginRight:1,padding:1,fontWeight:'bold',// paddingLeft: 5,\n// paddingRight: 5,\nborderRadius:3,fontSize:\"0.5em\",whiteSpace:\"nowrap\"},noTicketsDiv:{display:\"flex\",height:\"100px\",margin:40,flexDirection:\"column\",alignItems:\"center\",justifyContent:\"center\"},newMessagesCount:{justifySelf:\"flex-end\",textAlign:\"right\",position:\"relative\",top:0,color:\"green\",fontWeight:\"bold\",marginRight:\"10px\",borderRadius:0},noTicketsText:{textAlign:\"center\",color:\"rgb(104, 121, 146)\",fontSize:\"14px\",lineHeight:\"1.4\"},connectionTag:{background:\"green\",color:\"#FFF\",marginRight:1,padding:1,fontWeight:'bold',// paddingLeft: 5,\n// paddingRight: 5,\nborderRadius:3,fontSize:\"0.6em\"// whiteSpace: \"nowrap\"\n},noTicketsTitle:{textAlign:\"center\",fontSize:\"16px\",fontWeight:\"600\",margin:\"0px\"},contactNameWrapper:{display:\"flex\",justifyContent:\"space-between\",marginLeft:\"5px\",fontWeight:\"bold\",color:theme.mode==='light'?\"black\":\"white\"},lastMessageTime:{justifySelf:\"flex-end\",textAlign:\"right\",position:\"relative\",top:-30,marginRight:\"1px\",color:theme.mode==='light'?\"black\":grey[400]},lastMessageTimeUnread:{justifySelf:\"flex-end\",textAlign:\"right\",position:\"relative\",top:-30,color:\"green\",fontWeight:\"bold\",marginRight:\"1px\"},closedBadge:{alignSelf:\"center\",justifySelf:\"flex-end\",marginRight:32,marginLeft:\"auto\"},contactLastMessage:{paddingRight:\"0%\",marginLeft:\"5px\",color:theme.mode==='light'?\"black\":grey[400]},contactLastMessageUnread:{paddingRight:20,fontWeight:\"bold\",color:theme.mode==='light'?\"black\":grey[400],width:\"50%\"},badgeStyle:{color:\"white\",backgroundColor:green[500]},acceptButton:{position:\"absolute\",right:\"1px\"},ticketQueueColor:{flex:\"none\",// width: \"8px\",\nheight:\"100%\",position:\"absolute\",top:\"0%\",left:\"0%\"},ticketInfo:{position:\"relative\",top:-13},secondaryContentSecond:{display:'flex',// marginBottom: 2,\n// marginLeft: \"5px\",\nalignItems:\"flex-start\",flexWrap:\"nowrap\",flexDirection:\"row\",alignContent:\"flex-start\"// height: \"10px\"\n},ticketInfo1:{position:\"relative\",top:13,right:0},Radiusdot:{\"& .MuiBadge-badge\":{borderRadius:2,position:\"inherit\",height:16,margin:2,padding:3},\"& .MuiBadge-anchorOriginTopRightRectangle\":{transform:\"scale(1) translate(0%, -40%)\"}},connectionIcon:{marginRight:theme.spacing(1)}}));const TicketListItemCustom=_ref=>{var _ticket$contact,_ticket$contact2,_ticket$whatsapp2,_ticket$queue,_ticket$queue2,_ticket$user,_ticket$tags;let{setTabOpen,ticket}=_ref;const classes=useStyles();const theme=useTheme();const history=useHistory();const[loading,setLoading]=useState(false);const[acceptTicketWithouSelectQueueOpen,setAcceptTicketWithouSelectQueueOpen]=useState(false);const[transferTicketModalOpen,setTransferTicketModalOpen]=useState(false);const[openAlert,setOpenAlert]=useState(false);const[userTicketOpen,setUserTicketOpen]=useState(\"\");const[queueTicketOpen,setQueueTicketOpen]=useState(\"\");const{ticketId}=useParams();const isMounted=useRef(true);const{setCurrentTicket}=useContext(TicketsContext);const{user}=useContext(AuthContext);const{get:getSetting}=useCompanySettings();useEffect(()=>{},[ticket]);useEffect(()=>{return()=>{isMounted.current=false;};},[]);const handleOpenAcceptTicketWithouSelectQueue=useCallback(()=>{setAcceptTicketWithouSelectQueueOpen(true);},[]);const handleCloseTicket=async id=>{const setting=await getSetting({\"column\":\"requiredTag\"});if(setting.requiredTag===\"enabled\"){//verificar se tem uma tag   \ntry{const contactTags=await api.get(\"/contactTags/\".concat(ticket.contact.id));if(!contactTags.data.tags){toast.warning(i18n.t(\"messagesList.header.buttons.requiredTag\"));}else{await api.put(\"/tickets/\".concat(id),{status:\"closed\",userId:(user===null||user===void 0?void 0:user.id)||null});if(isMounted.current){setLoading(false);}history.push(\"/tickets/\");}}catch(err){setLoading(false);toastError(err);}}else{setLoading(true);try{await api.put(\"/tickets/\".concat(id),{status:\"closed\",userId:(user===null||user===void 0?void 0:user.id)||null});}catch(err){setLoading(false);toastError(err);}if(isMounted.current){setLoading(false);}history.push(\"/tickets/\");}};const handleCloseIgnoreTicket=async id=>{setLoading(true);try{await api.put(\"/tickets/\".concat(id),{status:\"closed\",userId:(user===null||user===void 0?void 0:user.id)||null,sendFarewellMessage:false,amountUsedBotQueues:0});}catch(err){setLoading(false);toastError(err);}if(isMounted.current){setLoading(false);}history.push(\"/tickets/\");};const truncate=(str,len)=>{if(!isNil(str)){if(str.length>len){return str.substring(0,len)+\"...\";}return str;}};const handleCloseTransferTicketModal=useCallback(()=>{if(isMounted.current){setTransferTicketModalOpen(false);}},[]);const handleOpenTransferModal=()=>{setLoading(true);setTransferTicketModalOpen(true);if(isMounted.current){setLoading(false);}handleSelectTicket(ticket);// history.push('/tickets');\n// setTimeout(() => {\nhistory.push(\"/tickets/\".concat(ticket.uuid));// }, 0);\n};const handleAcepptTicket=async id=>{setLoading(true);try{const otherTicket=await api.put(\"/tickets/\".concat(id),{status:ticket.isGroup&&ticket.channel==='whatsapp'?\"group\":\"open\",userId:user===null||user===void 0?void 0:user.id});if(otherTicket.data.id!==ticket.id){if(otherTicket.data.userId!==(user===null||user===void 0?void 0:user.id)){setOpenAlert(true);setUserTicketOpen(otherTicket.data.user.name);setQueueTicketOpen(otherTicket.data.queue.name);}else{setLoading(false);setTabOpen(ticket.isGroup?\"group\":\"open\");handleSelectTicket(otherTicket.data);// history.push('/tickets');\n// setTimeout(() => {\nhistory.push(\"/tickets/\".concat(otherTicket.uuid));// }, 0);\n}}else{var _ticket$whatsapp;let setting;try{setting=await getSetting({\"column\":\"sendGreetingAccepted\"});}catch(err){toastError(err);}if(setting.sendGreetingAccepted===\"enabled\"&&(!ticket.isGroup||((_ticket$whatsapp=ticket.whatsapp)===null||_ticket$whatsapp===void 0?void 0:_ticket$whatsapp.groupAsTicket)===\"enabled\")){handleSendMessage(ticket.id);}if(isMounted.current){setLoading(false);}setTabOpen(ticket.isGroup?\"group\":\"open\");handleSelectTicket(ticket);// history.push('/tickets');\n// setTimeout(() => {\nhistory.push(\"/tickets/\".concat(ticket.uuid));// }, 0);\n}}catch(err){setLoading(false);toastError(err);}};const handleSendMessage=async id=>{let setting;try{setting=await getSetting({\"column\":\"greetingAcceptedMessage\"});}catch(err){toastError(err);}const msg=\"\".concat(setting.greetingAcceptedMessage);//`{{ms}} *{{name}}*, ${i18n.t(\"mainDrawer.appBar.user.myName\")} *${user?.name}* ${i18n.t(\"mainDrawer.appBar.user.continuity\")}.`;\nconst message={read:1,fromMe:true,mediaUrl:\"\",body:\"\".concat(msg.trim())};try{await api.post(\"/messages/\".concat(id),message);}catch(err){toastError(err);}};const handleCloseAlert=useCallback(()=>{setOpenAlert(false);setLoading(false);},[]);const handleSelectTicket=ticket=>{const code=uuidv4();const{id,uuid}=ticket;setCurrentTicket({id,uuid,code});};return/*#__PURE__*/React.createElement(React.Fragment,{key:ticket.id},openAlert&&/*#__PURE__*/React.createElement(ShowTicketOpen,{isOpen:openAlert,handleClose:handleCloseAlert,user:userTicketOpen,queue:queueTicketOpen}),acceptTicketWithouSelectQueueOpen&&/*#__PURE__*/React.createElement(AcceptTicketWithouSelectQueue,{modalOpen:acceptTicketWithouSelectQueueOpen,onClose:e=>setAcceptTicketWithouSelectQueueOpen(false),ticketId:ticket.id,ticket:ticket}),transferTicketModalOpen&&/*#__PURE__*/React.createElement(TransferTicketModalCustom,{modalOpen:transferTicketModalOpen,onClose:handleCloseTransferTicketModal,ticketid:ticket.id,ticket:ticket}),/*#__PURE__*/React.createElement(ListItem,{button:true,dense:true,onClick:e=>{const isCheckboxClicked=e.target.tagName.toLowerCase()==='input'&&e.target.type==='checkbox'||e.target.tagName.toLowerCase()==='svg'&&e.target.type===undefined||e.target.tagName.toLowerCase()==='path'&&e.target.type===undefined;// Se o clique foi no Checkbox, nÃ£o execute handleSelectTicket\nif(isCheckboxClicked)return;handleSelectTicket(ticket);},selected:ticketId&&ticketId===ticket.uuid,className:clsx(classes.ticket,{[classes.pendingTicket]:ticket.status===\"pending\"})},/*#__PURE__*/React.createElement(ListItemAvatar,{style:{marginLeft:\"-15px\"}},/*#__PURE__*/React.createElement(Avatar,{style:{width:\"50px\",height:\"50px\",borderRadius:\"50%\"},src:\"\".concat(ticket===null||ticket===void 0?void 0:(_ticket$contact=ticket.contact)===null||_ticket$contact===void 0?void 0:_ticket$contact.urlPicture)})),/*#__PURE__*/React.createElement(ListItemText,{disableTypography:true,primary:/*#__PURE__*/React.createElement(\"span\",{className:classes.contactNameWrapper},/*#__PURE__*/React.createElement(Typography,{noWrap:true,component:\"span\",variant:\"body2\"// color=\"textPrimary\"\n},ticket.isGroup&&ticket.channel===\"whatsapp\"&&/*#__PURE__*/React.createElement(GroupIcon,{fontSize:\"small\",style:{color:grey[700],marginBottom:'-1px',marginLeft:'5px'}}),\" \\xA0\",ticket.channel&&/*#__PURE__*/React.createElement(ConnectionIcon,{width:\"20\",height:\"20\",className:classes.connectionIcon,connectionType:ticket.channel}),\" \\xA0\",truncate((_ticket$contact2=ticket.contact)===null||_ticket$contact2===void 0?void 0:_ticket$contact2.name,60))),secondary:/*#__PURE__*/React.createElement(\"span\",{className:classes.contactNameWrapper},/*#__PURE__*/React.createElement(Typography,{className:Number(ticket.unreadMessages)>0?classes.contactLastMessageUnread:classes.contactLastMessage,noWrap:true,component:\"span\",variant:\"body2\"},ticket.lastMessage?/*#__PURE__*/React.createElement(React.Fragment,null,ticket.lastMessage.includes('data:image/png;base64')?/*#__PURE__*/React.createElement(MarkdownWrapper,null,\"Localiza\\xE7\\xE3o\"):/*#__PURE__*/React.createElement(React.Fragment,null,\" \",ticket.lastMessage.includes('BEGIN:VCARD')?/*#__PURE__*/React.createElement(MarkdownWrapper,null,\"Contato\"):/*#__PURE__*/React.createElement(MarkdownWrapper,null,truncate(ticket.lastMessage,40)))):/*#__PURE__*/React.createElement(\"br\",null),/*#__PURE__*/React.createElement(\"span\",{className:classes.secondaryContentSecond},(ticket===null||ticket===void 0?void 0:ticket.whatsapp)?/*#__PURE__*/React.createElement(Badge,{className:classes.connectionTag,style:{backgroundColor:ticket.channel===\"whatsapp\"?\"#25D366\":ticket.channel===\"facebook\"?\"#4267B2\":\"#E1306C\"}},(_ticket$whatsapp2=ticket.whatsapp)===null||_ticket$whatsapp2===void 0?void 0:_ticket$whatsapp2.name.toUpperCase()):/*#__PURE__*/React.createElement(\"br\",null),/*#__PURE__*/React.createElement(Badge,{style:{backgroundColor:((_ticket$queue=ticket.queue)===null||_ticket$queue===void 0?void 0:_ticket$queue.color)||\"#7c7c7c\"},className:classes.connectionTag},ticket.queueId?(_ticket$queue2=ticket.queue)===null||_ticket$queue2===void 0?void 0:_ticket$queue2.name.toUpperCase():ticket.status===\"lgpd\"?\"LGPD\":\"SEM FILA\"),(ticket===null||ticket===void 0?void 0:ticket.user)&&/*#__PURE__*/React.createElement(Badge,{style:{backgroundColor:\"#000000\"},className:classes.connectionTag},(_ticket$user=ticket.user)===null||_ticket$user===void 0?void 0:_ticket$user.name.toUpperCase())),/*#__PURE__*/React.createElement(\"span\",{className:classes.secondaryContentSecond},(_ticket$tags=ticket.tags)===null||_ticket$tags===void 0?void 0:_ticket$tags.map(tag=>{return/*#__PURE__*/React.createElement(ContactTag,{tag:tag,key:\"ticket-contact-tag-\".concat(ticket.id,\"-\").concat(tag.id)});}))),/*#__PURE__*/React.createElement(Badge,{className:classes.newMessagesCount,badgeContent:ticket.unreadMessages,classes:{badge:classes.badgeStyle}}))}),/*#__PURE__*/React.createElement(ListItemSecondaryAction,null,ticket.lastMessage&&/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(Typography,{className:Number(ticket.unreadMessages)>0?classes.lastMessageTimeUnread:classes.lastMessageTime,component:\"span\",variant:\"body2\"// color=\"textSecondary\"\n},isSameDay(parseISO(ticket.updatedAt),new Date())?/*#__PURE__*/React.createElement(React.Fragment,null,format(parseISO(ticket.updatedAt),\"HH:mm\")):/*#__PURE__*/React.createElement(React.Fragment,null,format(parseISO(ticket.updatedAt),\"dd/MM/yyyy\"))),/*#__PURE__*/React.createElement(\"br\",null))),/*#__PURE__*/React.createElement(ListItemSecondaryAction,null,/*#__PURE__*/React.createElement(\"span\",{className:classes.secondaryContentSecond},ticket.status===\"pending\"&&(ticket.queueId===null||ticket.queueId===undefined)&&/*#__PURE__*/React.createElement(ButtonWithSpinner//color=\"primary\"\n,{style:{backgroundColor:'transparent',boxShadow:'none',border:'none',color:theme.mode===\"light\"?\"#0872B9\":\"#FFF\",padding:'0px',borderRadius:\"50%\",right:'51px',fontSize:'0.6rem',bottom:'-30px',minWidth:'2em',width:'auto'},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleOpenAcceptTicketWithouSelectQueue()},/*#__PURE__*/React.createElement(Tooltip,{title:\"\".concat(i18n.t(\"ticketsList.buttons.accept\"))},/*#__PURE__*/React.createElement(Done,null)))),/*#__PURE__*/React.createElement(\"span\",{className:classes.secondaryContentSecond},ticket.status===\"pending\"&&ticket.queueId!==null&&/*#__PURE__*/React.createElement(ButtonWithSpinner//color=\"primary\"\n,{style:{backgroundColor:'transparent',boxShadow:'none',border:'none',color:theme.mode===\"light\"?\"#0872B9\":\"#FFF\",padding:'0px',borderRadius:\"50%\",right:'51px',fontSize:'0.6rem',bottom:'-30px',minWidth:'2em',width:'auto'},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleAcepptTicket(ticket.id)},/*#__PURE__*/React.createElement(Tooltip,{title:\"\".concat(i18n.t(\"ticketsList.buttons.accept\"))},/*#__PURE__*/React.createElement(Done,null)))),/*#__PURE__*/React.createElement(\"span\",{className:classes.secondaryContentSecond1},(ticket.status===\"pending\"||ticket.status===\"open\"||ticket.status===\"group\")&&/*#__PURE__*/React.createElement(ButtonWithSpinner//color=\"primary\"\n,{style:{backgroundColor:'transparent',boxShadow:'none',border:'none',color:theme.mode===\"light\"?\"#0872B9\":\"#FFF\",padding:'0px',borderRadius:\"50%\",right:'26px',position:'absolute',fontSize:'0.6rem',bottom:'-30px',minWidth:'2em',width:'auto'},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:handleOpenTransferModal},/*#__PURE__*/React.createElement(Tooltip,{title:\"\".concat(i18n.t(\"ticketsList.buttons.transfer\"))},/*#__PURE__*/React.createElement(SwapHoriz,null)))),/*#__PURE__*/React.createElement(\"span\",{className:classes.secondaryContentSecond},(ticket.status===\"open\"||ticket.status===\"group\")&&/*#__PURE__*/React.createElement(ButtonWithSpinner//color=\"primary\"\n,{style:{backgroundColor:'transparent',boxShadow:'none',border:'none',color:theme.mode===\"light\"?\"#0872B9\":\"#FFF\",padding:'0px',bottom:'0px',borderRadius:\"50%\",right:'1px',fontSize:'0.6rem',bottom:'-30px',minWidth:'2em',width:'auto'},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleCloseTicket(ticket.id)},/*#__PURE__*/React.createElement(Tooltip,{title:\"\".concat(i18n.t(\"ticketsList.buttons.closed\"))},/*#__PURE__*/React.createElement(HighlightOff,null)))),/*#__PURE__*/React.createElement(\"span\",{className:classes.secondaryContentSecond},(ticket.status===\"pending\"||ticket.status===\"lgpd\")&&(user.userClosePendingTicket===\"enabled\"||user.profile===\"admin\")&&/*#__PURE__*/React.createElement(ButtonWithSpinner//color=\"primary\"\n,{style:{backgroundColor:'transparent',boxShadow:'none',border:'none',color:theme.mode===\"light\"?\"#0872B9\":\"#FFF\",padding:'0px',bottom:'0px',borderRadius:\"50%\",right:'1px',fontSize:'0.6rem',bottom:'-30px',minWidth:'2em',width:'auto'},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleCloseIgnoreTicket(ticket.id)},/*#__PURE__*/React.createElement(Tooltip,{title:\"\".concat(i18n.t(\"ticketsList.buttons.ignore\"))},/*#__PURE__*/React.createElement(HighlightOff,null)))),/*#__PURE__*/React.createElement(\"span\",{className:classes.secondaryContentSecond},ticket.status===\"closed\"&&(ticket.queueId===null||ticket.queueId===undefined)&&/*#__PURE__*/React.createElement(ButtonWithSpinner//color=\"primary\"\n,{style:{backgroundColor:'transparent',boxShadow:'none',border:'none',color:theme.mode===\"light\"?\"#0872B9\":\"#FFF\",padding:'0px',bottom:'0px',borderRadius:\"50%\",right:'1px',fontSize:'0.6rem',bottom:'-30px',minWidth:'2em',width:'auto'},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleOpenAcceptTicketWithouSelectQueue()},/*#__PURE__*/React.createElement(Tooltip,{title:\"\".concat(i18n.t(\"ticketsList.buttons.reopen\"))},/*#__PURE__*/React.createElement(Replay,null)))),/*#__PURE__*/React.createElement(\"span\",{className:classes.secondaryContentSecond},ticket.status===\"closed\"&&ticket.queueId!==null&&/*#__PURE__*/React.createElement(ButtonWithSpinner//color=\"primary\"\n,{style:{backgroundColor:'transparent',boxShadow:'none',border:'none',color:theme.mode===\"light\"?\"#0872B9\":\"#FFF\",padding:'0px',bottom:'0px',borderRadius:\"50%\",right:'1px',fontSize:'0.6rem',bottom:'-30px',minWidth:'2em',width:'auto'},variant:\"contained\",className:classes.acceptButton,size:\"small\",loading:loading,onClick:e=>handleAcepptTicket(ticket.id)},/*#__PURE__*/React.createElement(Tooltip,{title:\"\".concat(i18n.t(\"ticketsList.buttons.reopen\"))},/*#__PURE__*/React.createElement(Replay,null)))))));};export default TicketListItemCustom;","map":null,"metadata":{},"sourceType":"module"}