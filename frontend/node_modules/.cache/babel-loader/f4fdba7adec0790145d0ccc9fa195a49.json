{"ast":null,"code":"import React,{useState,useEffect,useReducer,useContext}from\"react\";import{toast}from\"react-toastify\";// import { SocketContext } from \"../../context/Socket/SocketContext\";\nimport n8n from\"../../assets/n8n.png\";import dialogflow from\"../../assets/dialogflow.png\";import webhooks from\"../../assets/webhook.png\";import typebot from\"../../assets/typebot.jpg\";import flowbuilder from\"../../assets/flowbuilders.png\";import{makeStyles}from\"@material-ui/core/styles\";import{Avatar,Button,IconButton,InputAdornment,Paper,Table,TableBody,TableCell,TableHead,TableRow,TextField,Tooltip}from\"@material-ui/core\";import{DeleteOutline,Edit}from\"@material-ui/icons\";import SearchIcon from\"@material-ui/icons/Search\";import MainContainer from\"../../components/MainContainer\";import MainHeader from\"../../components/MainHeader\";import MainHeaderButtonsWrapper from\"../../components/MainHeaderButtonsWrapper\";import Title from\"../../components/Title\";import TableRowSkeleton from\"../../components/TableRowSkeleton\";import IntegrationModal from\"../../components/QueueIntegrationModal\";import ConfirmationModal from\"../../components/ConfirmationModal\";import api from\"../../services/api\";import{i18n}from\"../../translate/i18n\";import toastError from\"../../errors/toastError\";import{AuthContext}from\"../../context/Auth/AuthContext\";import usePlans from\"../../hooks/usePlans\";import{useHistory}from\"react-router-dom/cjs/react-router-dom.min\";import ForbiddenPage from\"../../components/ForbiddenPage\";const reducer=(state,action)=>{if(action.type===\"LOAD_INTEGRATIONS\"){const queueIntegration=action.payload;const newIntegrations=[];queueIntegration.forEach(integration=>{const integrationIndex=state.findIndex(u=>u.id===integration.id);if(integrationIndex!==-1){state[integrationIndex]=integration;}else{newIntegrations.push(integration);}});return[...state,...newIntegrations];}if(action.type===\"UPDATE_INTEGRATIONS\"){const queueIntegration=action.payload;const integrationIndex=state.findIndex(u=>u.id===queueIntegration.id);if(integrationIndex!==-1){state[integrationIndex]=queueIntegration;return[...state];}else{return[queueIntegration,...state];}}if(action.type===\"DELETE_INTEGRATION\"){const integrationId=action.payload;const integrationIndex=state.findIndex(u=>u.id===integrationId);if(integrationIndex!==-1){state.splice(integrationIndex,1);}return[...state];}if(action.type===\"RESET\"){return[];}};const useStyles=makeStyles(theme=>({mainPaper:{flex:1,padding:theme.spacing(2),margin:theme.spacing(1),overflowY:\"scroll\",...theme.scrollbarStyles},avatar:{width:\"140px\",height:\"40px\",borderRadius:4}}));const QueueIntegration=()=>{const classes=useStyles();const[loading,setLoading]=useState(false);const[pageNumber,setPageNumber]=useState(1);const[hasMore,setHasMore]=useState(false);const[selectedIntegration,setSelectedIntegration]=useState(null);const[deletingUser,setDeletingUser]=useState(null);const[userModalOpen,setUserModalOpen]=useState(false);const[confirmModalOpen,setConfirmModalOpen]=useState(false);const[searchParam,setSearchParam]=useState(\"\");const[queueIntegration,dispatch]=useReducer(reducer,[]);//   const socketManager = useContext(SocketContext);\nconst{user,socket}=useContext(AuthContext);const{getPlanCompany}=usePlans();const companyId=user.companyId;const history=useHistory();useEffect(()=>{async function fetchData(){const planConfigs=await getPlanCompany(undefined,companyId);if(!planConfigs.plan.useIntegrations){toast.error(\"Esta empresa não possui permissão para acessar essa página! Estamos lhe redirecionando.\");setTimeout(()=>{history.push(\"/\");},1000);}}fetchData();// eslint-disable-next-line react-hooks/exhaustive-deps\n},[]);useEffect(()=>{dispatch({type:\"RESET\"});setPageNumber(1);},[searchParam]);useEffect(()=>{setLoading(true);const delayDebounceFn=setTimeout(()=>{const fetchIntegrations=async()=>{try{const{data}=await api.get(\"/queueIntegration/\",{params:{searchParam,pageNumber}});dispatch({type:\"LOAD_INTEGRATIONS\",payload:data.queueIntegrations});setHasMore(data.hasMore);setLoading(false);}catch(err){toastError(err);}};fetchIntegrations();},500);return()=>clearTimeout(delayDebounceFn);},[searchParam,pageNumber]);useEffect(()=>{// const socket = socketManager.GetSocket();\nconst onQueueEvent=data=>{if(data.action===\"update\"||data.action===\"create\"){dispatch({type:\"UPDATE_INTEGRATIONS\",payload:data.queueIntegration});}if(data.action===\"delete\"){dispatch({type:\"DELETE_INTEGRATION\",payload:+data.integrationId});}};socket.on(\"company-\".concat(companyId,\"-queueIntegration\"),onQueueEvent);return()=>{socket.off(\"company-\".concat(companyId,\"-queueIntegration\"),onQueueEvent);};},[]);const handleOpenUserModal=()=>{setSelectedIntegration(null);setUserModalOpen(true);};const handleCloseIntegrationModal=()=>{setSelectedIntegration(null);setUserModalOpen(false);};const handleSearch=event=>{setSearchParam(event.target.value.toLowerCase());};const handleEditIntegration=queueIntegration=>{setSelectedIntegration(queueIntegration);setUserModalOpen(true);};const handleDeleteIntegration=async integrationId=>{try{await api.delete(\"/queueIntegration/\".concat(integrationId));toast.success(i18n.t(\"queueIntegration.toasts.deleted\"));}catch(err){toastError(err);}setDeletingUser(null);setSearchParam(\"\");setPageNumber(1);};const loadMore=()=>{setPageNumber(prevState=>prevState+1);};const handleScroll=e=>{if(!hasMore||loading)return;const{scrollTop,scrollHeight,clientHeight}=e.currentTarget;if(scrollHeight-(scrollTop+100)<clientHeight){loadMore();}};return/*#__PURE__*/React.createElement(MainContainer,null,/*#__PURE__*/React.createElement(ConfirmationModal,{title:deletingUser&&\"\".concat(i18n.t(\"queueIntegration.confirmationModal.deleteTitle\"),\" \").concat(deletingUser.name,\"?\"),open:confirmModalOpen,onClose:setConfirmModalOpen,onConfirm:()=>handleDeleteIntegration(deletingUser.id)},i18n.t(\"queueIntegration.confirmationModal.deleteMessage\")),/*#__PURE__*/React.createElement(IntegrationModal,{open:userModalOpen,onClose:handleCloseIntegrationModal,\"aria-labelledby\":\"form-dialog-title\",integrationId:selectedIntegration&&selectedIntegration.id}),user.profile===\"user\"?/*#__PURE__*/React.createElement(ForbiddenPage,null):/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(MainHeader,null,/*#__PURE__*/React.createElement(Title,null,i18n.t(\"queueIntegration.title\"),\" (\",queueIntegration.length,\")\"),/*#__PURE__*/React.createElement(MainHeaderButtonsWrapper,null,/*#__PURE__*/React.createElement(TextField,{placeholder:i18n.t(\"queueIntegration.searchPlaceholder\"),type:\"search\",value:searchParam,onChange:handleSearch,InputProps:{startAdornment:/*#__PURE__*/React.createElement(InputAdornment,{position:\"start\"},/*#__PURE__*/React.createElement(SearchIcon,{color:\"secondary\"}))}}),/*#__PURE__*/React.createElement(Button,{variant:\"contained\",color:\"primary\",onClick:handleOpenUserModal},i18n.t(\"queueIntegration.buttons.add\")))),/*#__PURE__*/React.createElement(Paper,{className:classes.mainPaper,variant:\"outlined\",onScroll:handleScroll},/*#__PURE__*/React.createElement(Table,{size:\"small\"},/*#__PURE__*/React.createElement(TableHead,null,/*#__PURE__*/React.createElement(TableRow,null,/*#__PURE__*/React.createElement(TableCell,{padding:\"checkbox\"}),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},i18n.t(\"queueIntegration.table.id\")),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},i18n.t(\"queueIntegration.table.name\")))),/*#__PURE__*/React.createElement(TableBody,null,/*#__PURE__*/React.createElement(React.Fragment,null,queueIntegration.map(integration=>/*#__PURE__*/React.createElement(TableRow,{key:integration.id},/*#__PURE__*/React.createElement(TableCell,null,integration.type===\"dialogflow\"&&/*#__PURE__*/React.createElement(Avatar,{src:dialogflow,className:classes.avatar}),integration.type===\"n8n\"&&/*#__PURE__*/React.createElement(Avatar,{src:n8n,className:classes.avatar}),integration.type===\"webhook\"&&/*#__PURE__*/React.createElement(Avatar,{src:webhooks,className:classes.avatar}),integration.type===\"typebot\"&&/*#__PURE__*/React.createElement(Avatar,{src:typebot,className:classes.avatar}),integration.type===\"flowbuilder\"&&/*#__PURE__*/React.createElement(Avatar,{src:flowbuilder,className:classes.avatar})),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},integration.id),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},integration.name),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},/*#__PURE__*/React.createElement(IconButton,{size:\"small\",onClick:()=>handleEditIntegration(integration)},/*#__PURE__*/React.createElement(Edit,{color:\"secondary\"})),/*#__PURE__*/React.createElement(IconButton,{size:\"small\",onClick:e=>{setConfirmModalOpen(true);setDeletingUser(integration);}},/*#__PURE__*/React.createElement(DeleteOutline,{color:\"secondary\"}))))),loading&&/*#__PURE__*/React.createElement(TableRowSkeleton,{columns:7})))))));};export default QueueIntegration;","map":null,"metadata":{},"sourceType":"module"}