{"ast":null,"code":"import React,{useState,useEffect,useRef,useContext}from\"react\";import*as Yup from\"yup\";import{Formik,Form,Field}from\"formik\";import{toast}from\"react-toastify\";import{head}from\"lodash\";import{makeStyles}from\"@material-ui/core/styles\";import{green}from\"@material-ui/core/colors\";import Button from\"@material-ui/core/Button\";import IconButton from\"@material-ui/core/IconButton\";import TextField from\"@material-ui/core/TextField\";import Dialog from\"@material-ui/core/Dialog\";import DialogActions from\"@material-ui/core/DialogActions\";import DialogContent from\"@material-ui/core/DialogContent\";import DialogTitle from\"@material-ui/core/DialogTitle\";import CircularProgress from\"@material-ui/core/CircularProgress\";import AttachFileIcon from\"@material-ui/icons/AttachFile\";import DeleteOutlineIcon from\"@material-ui/icons/DeleteOutline\";import{i18n}from\"../../translate/i18n\";import moment from\"moment\";import api from\"../../services/api\";import toastError from\"../../errors/toastError\";import{Box,FormControl,Grid,InputLabel,ListItemText,MenuItem,Select,Tab,Tabs,Typography}from\"@material-ui/core\";import{AuthContext}from\"../../context/Auth/AuthContext\";import ConfirmationModal from\"../ConfirmationModal\";import{Autocomplete,Checkbox,Chip,Stack}from\"@mui/material\";const useStyles=makeStyles(theme=>({root:{display:\"flex\",flexWrap:\"wrap\"},textField:{marginRight:theme.spacing(1),flex:1},extraAttr:{display:\"flex\",justifyContent:\"center\",alignItems:\"center\"},btnWrapper:{position:\"relative\"},buttonProgress:{color:green[500],position:\"absolute\",top:\"50%\",left:\"50%\",marginTop:-12,marginLeft:-12}}));const CampaignModalPhrase=_ref=>{let{open,onClose,FlowCampaignId,onSave}=_ref;const classes=useStyles();const isMounted=useRef(true);const{user}=useContext(AuthContext);const{companyId}=user;const[campaignEditable,setCampaignEditable]=useState(true);const attachmentFile=useRef(null);const[dataItem,setDataItem]=useState({name:\"\",phrase:\"\"});const[dataItemError,setDataItemError]=useState({name:false,flowId:false,phrase:false});const[flowSelected,setFlowSelected]=useState();const[flowsData,setFlowsData]=useState([]);const[flowsDataComplete,setFlowsDataComplete]=useState([]);const[selectedWhatsapp,setSelectedWhatsapp]=useState(\"\");const[whatsAppNames,setWhatsAppNames]=useState([]);const[whatsApps,setWhatsApps]=useState([]);const[whatsAppSelected,setWhatsAppSelected]=useState({});const[active,setActive]=useState(true);const[loading,setLoading]=useState(true);const getFlows=async()=>{const flows=await api.get(\"/flowbuilder\");setFlowsDataComplete(flows.data.flows);setFlowsData(flows.data.flows.map(flow=>flow.name));return flows.data.flows;};const detailsPhrase=async flows=>{setLoading(true);await api.get(\"/flowcampaign/\".concat(FlowCampaignId)).then(res=>{console.log(\"dete\",res.data);setDataItem({name:res.data.details.name,phrase:res.data.details.phrase});setActive(res.data.details.status);const nameFlow=flows.filter(itemFlows=>itemFlows.id===res.data.details.flowId);if(nameFlow.length>0){setFlowSelected(nameFlow[0].name);}setLoading(false);});};const handleClose=()=>{onClose();};const openModal=async()=>{const flows=await getFlows();if(FlowCampaignId){await detailsPhrase(flows);}else{clearData();setLoading(false);}};useEffect(()=>{setLoading(true);const delayDebounceFn=setTimeout(()=>{const fetchContacts=async()=>{api.get(\"/whatsapp\",{params:{companyId,session:0}}).then(_ref2=>{let{data}=_ref2;setWhatsApps(data);});};fetchContacts();setLoading(false);},500);return()=>clearTimeout(delayDebounceFn);},[]);useEffect(()=>{setLoading(true);if(open===true){openModal();}},[open]);const clearErrors=()=>{setDataItemError({name:false,flowId:false,whatsappId:false,phrase:false});};const clearData=()=>{setFlowSelected();setDataItem({name:\"\",phrase:\"\"});};const applicationSaveAndEdit=()=>{let error=0;if(dataItem.name===\"\"||dataItem.name.length===0){setDataItemError(old=>({...old,name:true}));error++;}if(!flowSelected){setDataItemError(old=>({...old,flowId:true}));error++;}if(dataItem.phrase===\"\"||dataItem.phrase.length===0){setDataItemError(old=>({...old,phrase:true}));error++;}if(!selectedWhatsapp){setDataItemError(old=>({...old,whatsappId:true}));}if(error!==0){return;}const idFlow=flowsDataComplete.filter(item=>item.name===flowSelected)[0].id;const whatsappId=selectedWhatsapp!==\"\"?selectedWhatsapp:null;if(FlowCampaignId){api.put(\"/flowcampaign\",{id:FlowCampaignId,name:dataItem.name,flowId:idFlow,whatsappId:whatsappId,phrase:dataItem.phrase,status:active});onClose();onSave('ok');toast.success(\"Frase alterada com sucesso!\");clearData();}else{api.post(\"/flowcampaign\",{name:dataItem.name,flowId:idFlow,whatsappId:whatsappId,phrase:dataItem.phrase});onClose();onSave('ok');toast.success(\"Frase criada com sucesso!\");clearData();}};return/*#__PURE__*/React.createElement(\"div\",{className:classes.root},/*#__PURE__*/React.createElement(Dialog,{open:open,onClose:handleClose,fullWidth:true,maxWidth:\"md\",scroll:\"paper\"},/*#__PURE__*/React.createElement(DialogTitle,{id:\"form-dialog-title\"},campaignEditable?/*#__PURE__*/React.createElement(React.Fragment,null,FlowCampaignId?\"Editar campanha com fluxo por frase\":\"Nova campanha com fluxo por frase\"):/*#__PURE__*/React.createElement(React.Fragment,null,\"\".concat(i18n.t(\"campaigns.dialog.readonly\")))),/*#__PURE__*/React.createElement(\"div\",{style:{display:\"none\"}},/*#__PURE__*/React.createElement(\"input\",{type:\"file\",ref:attachmentFile})),!loading&&/*#__PURE__*/React.createElement(Stack,{sx:{padding:\"52px\"}},/*#__PURE__*/React.createElement(Stack,{sx:{gap:\"14px\"}},/*#__PURE__*/React.createElement(Stack,{gap:1},/*#__PURE__*/React.createElement(Typography,null,\"Nome do disparo por frase\"),/*#__PURE__*/React.createElement(TextField,{label:\"\",name:\"text\",variant:\"outlined\",error:dataItemError.name,defaultValue:dataItem.name,margin:\"dense\",onChange:e=>{setDataItem(old=>{let newValue=old;newValue.name=e.target.value;return newValue;});},className:classes.textField,style:{width:\"100%\"}})),/*#__PURE__*/React.createElement(Stack,{gap:1},/*#__PURE__*/React.createElement(Typography,null,\"Escolha um fluxo\"),/*#__PURE__*/React.createElement(Autocomplete,{disablePortal:true,id:\"combo-box-demo\",value:flowSelected,error:dataItemError.flowId,defaultValue:flowSelected,options:flowsData,onChange:(event,newValue)=>{setFlowSelected(newValue);},sx:{width:\"100%\"},renderInput:params=>/*#__PURE__*/React.createElement(TextField,Object.assign({},params,{error:dataItemError.flowId,variant:\"outlined\",style:{width:\"100%\"},placeholder:\"Escolha um fluxo\"})),renderTags:(value,getTagProps)=>value.map((option,index)=>/*#__PURE__*/React.createElement(Chip,Object.assign({variant:\"outlined\",label:option},getTagProps({index}),{style:{borderRadius:\"8px\"}})))})),/*#__PURE__*/React.createElement(Stack,{gap:1},/*#__PURE__*/React.createElement(Select,{required:true,fullWidth:true,displayEmpty:true,variant:\"outlined\",value:selectedWhatsapp,onChange:e=>{setSelectedWhatsapp(e.target.value);},MenuProps:{anchorOrigin:{vertical:\"bottom\",horizontal:\"left\"},transformOrigin:{vertical:\"top\",horizontal:\"left\"},getContentAnchorEl:null},renderValue:()=>{if(selectedWhatsapp===\"\"){return\"Selecione uma ConexÃ£o\";}const whatsapp=whatsApps.find(w=>w.id===selectedWhatsapp);return whatsapp.name;}},(whatsApps===null||whatsApps===void 0?void 0:whatsApps.length)>0&&whatsApps.map((whatsapp,key)=>/*#__PURE__*/React.createElement(MenuItem,{dense:true,key:key,value:whatsapp.id},/*#__PURE__*/React.createElement(ListItemText,{primary:/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(Typography,{component:\"span\",style:{fontSize:14,marginLeft:\"10px\",display:\"inline-flex\",alignItems:\"center\",lineHeight:\"2\"}},whatsapp.name,\" \\xA0 \",/*#__PURE__*/React.createElement(\"p\",{className:whatsapp.status==='CONNECTED'?classes.online:classes.offline},\"(\",whatsapp.status,\")\")))}))))),/*#__PURE__*/React.createElement(Stack,{gap:1},/*#__PURE__*/React.createElement(Typography,null,\"Qual frase dispara o fluxo?\"),/*#__PURE__*/React.createElement(TextField,{label:\"\",name:\"text\",variant:\"outlined\",error:dataItemError.phrase,defaultValue:dataItem.phrase,margin:\"dense\",onChange:e=>{setDataItem(old=>{let newValue=old;newValue.phrase=e.target.value;return newValue;});},className:classes.textField,style:{width:\"100%\"}})),/*#__PURE__*/React.createElement(Stack,{direction:'row',gap:2},/*#__PURE__*/React.createElement(Stack,{justifyContent:'center'},/*#__PURE__*/React.createElement(Typography,null,\"Status\")),/*#__PURE__*/React.createElement(Checkbox,{checked:active,onChange:()=>setActive(old=>!old)}))),/*#__PURE__*/React.createElement(Stack,{direction:\"row\",spacing:2,alignSelf:\"end\",marginTop:\"16px\"},/*#__PURE__*/React.createElement(Button,{variant:\"outlined\",onClick:()=>{onClose();clearErrors();}},\"Cancelar\"),FlowCampaignId?/*#__PURE__*/React.createElement(Button,{variant:\"contained\",color:\"primary\",onClick:()=>applicationSaveAndEdit()},\"Salvar campanha\"):/*#__PURE__*/React.createElement(Button,{variant:\"contained\",color:\"primary\",onClick:()=>applicationSaveAndEdit()},\"Criar campanha\"))),loading&&/*#__PURE__*/React.createElement(Stack,{justifyContent:\"center\",alignItems:\"center\",minHeight:\"10vh\",sx:{padding:\"52px\"}},/*#__PURE__*/React.createElement(CircularProgress,null))));};export default CampaignModalPhrase;","map":null,"metadata":{},"sourceType":"module"}