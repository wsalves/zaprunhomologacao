{"ast":null,"code":"import React,{useState,useEffect,useReducer,useContext}from\"react\";import{toast}from\"react-toastify\";import{useHistory}from\"react-router-dom\";import{makeStyles}from\"@material-ui/core/styles\";import Table from\"@material-ui/core/Table\";import TableBody from\"@material-ui/core/TableBody\";import TableCell from\"@material-ui/core/TableCell\";import TableHead from\"@material-ui/core/TableHead\";import TableRow from\"@material-ui/core/TableRow\";import Paper from\"@material-ui/core/Paper\";import Button from\"@material-ui/core/Button\";import Pagination from\"@material-ui/lab/Pagination\";import*as XLSX from'xlsx';import api from\"../../services/api\";import TableRowSkeleton from\"../../components/TableRowSkeleton\";import{i18n}from\"../../translate/i18n\";import MainHeader from\"../../components/MainHeader\";import Title from\"../../components/Title\";import MainHeaderButtonsWrapper from\"../../components/MainHeaderButtonsWrapper\";import MainContainer from\"../../components/MainContainer\";import toastError from\"../../errors/toastError\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{Can}from\"../../components/Can\";import{CircularProgress,FormControl,FormControlLabel,Grid,IconButton,InputLabel,MenuItem,Select,Switch,TextField,Tooltip,Typography}from\"@material-ui/core\";import{UsersFilter}from\"../../components/UsersFilter\";import{TagsFilter}from\"../../components/TagsFilter\";import{WhatsappsFilter}from\"../../components/WhatsappsFilter\";import{StatusFilter}from\"../../components/StatusFilter\";import useDashboard from\"../../hooks/useDashboard\";import QueueSelectCustom from\"../../components/QueueSelectCustom\";import moment from\"moment\";import ShowTicketLogModal from\"../../components/ShowTicketLogModal\";import{blue,green}from\"@material-ui/core/colors\";import{Facebook,Forward,History,Instagram,SaveAlt,Visibility,WhatsApp}from\"@material-ui/icons\";import Autocomplete,{createFilterOptions}from\"@material-ui/lab/Autocomplete\";import{Field}from\"formik\";const useStyles=makeStyles(theme=>({mainContainer:{background:theme.palette.fancyBackground},formControl:{display:'flex',flexDirection:'row',justifyContent:'center',alignItems:'center'},mainPaper:{flex:1,marginTop:40,borderRadius:20,border:'0px !important',marginBottom:40,overflow:'hidden'},mainPaperTable:{flex:1,overflow:'auto',height:'68vh',...theme.scrollbarStylesSoftBig},mainPaperFilter:{flex:1,overflow:'auto',height:'20vh',...theme.scrollbarStylesSoftBig},mainHeaderBlock:{[theme.breakpoints.down('md')]:{display:'flex',flexWrap:'wrap'}},filterItem:{width:200,[theme.breakpoints.down('md')]:{width:'45%'}}}));const Reports=()=>{const classes=useStyles();const history=useHistory();const{getReport}=useDashboard();const{user}=useContext(AuthContext);const[loading,setLoading]=useState(false);const[pageNumber,setPageNumber]=useState(1);const[pageSize,setPageSize]=useState(10);// Defina o tamanho da página\nconst[searchParam,setSearchParam]=useState(\"\");const[selectedContactId,setSelectedContactId]=useState(null);const[selectedWhatsapp,setSelectedWhatsapp]=useState([]);const[selectedStatus,setSelectedStatus]=useState([]);const[selectedContact,setSelectedContact]=useState(null);// const [tagIds, setTagIds] = useState([]);\nconst[queueIds,setQueueIds]=useState([]);const[userIds,setUserIds]=useState([]);const[options,setOptions]=useState([]);const[dateFrom,setDateFrom]=useState(moment(\"1\",\"D\").format(\"YYYY-MM-DD\"));const[dateTo,setDateTo]=useState(moment().format(\"YYYY-MM-DD\"));const[onlyRated,setOnlyRated]=useState(false);const[totalTickets,setTotalTickets]=useState(0);const[tickets,setTickets]=useState([]);const[openTicketMessageDialog,setOpenTicketMessageDialog]=useState(false);const[ticketOpen,setTicketOpen]=useState(null);const[hasMore,setHasMore]=useState(false);useEffect(()=>{setLoading(true);const delayDebounceFn=setTimeout(()=>{const fetchContacts=async()=>{try{const{data}=await api.get(\"contacts\",{params:{searchParam}});setOptions(data.contacts);setLoading(false);}catch(err){setLoading(false);toastError(err);}};fetchContacts();},500);return()=>clearTimeout(delayDebounceFn);},[searchParam]);// const handleSelectedTags = (selecteds) => {\n//   const tags = selecteds.map((t) => t.id);\n//   setTagIds(tags);\n// };\nconst exportarGridParaExcel=async()=>{setLoading(true);// Define o estado de loading como true durante o carregamento\ntry{const data=await getReport({searchParam,contactId:selectedContactId,whatsappId:JSON.stringify(selectedWhatsapp),// tags: JSON.stringify(tagIds),\nusers:JSON.stringify(userIds),queueIds:JSON.stringify(queueIds),status:JSON.stringify(selectedStatus),// tags: tagIds,\ndateFrom,dateTo,page:1,// Passa o número da página para a API\npageSize:9999999,// Passa o tamanho da página para a API\nonlyRated:onlyRated?\"true\":\"false\"});const ticketsData=data.tickets.map(ticket=>{// Convertendo o campo createdAt para um objeto Date\nconst createdAt=new Date(ticket.createdAt);const closedAt=new Date(ticket.closedAt);const dataFechamento=closedAt.toLocaleDateString();const horaFechamento=closedAt.toLocaleTimeString();// Obtendo a data e a hora separadamente\nconst dataCriacao=createdAt.toLocaleDateString();// Obtém a data no formato 'dd/mm/aaaa'\nconst horaCriacao=createdAt.toLocaleTimeString();// Obtém a hora no formato 'hh:mm:ss'\nreturn{id:ticket.id,Conexão:ticket.whatsappName,Contato:ticket.contactName,Usuário:ticket.userName,Fila:ticket.queueName,Status:ticket.status,ÚltimaMensagem:ticket.lastMessage,DataAbertura:dataCriacao,HoraAbertura:horaCriacao,DataFechamento:ticket.closedAt===null?\"\":dataFechamento,HoraFechamento:ticket.closedAt===null?\"\":horaFechamento,TempoDeAtendimento:ticket.supportTime,nps:ticket.NPS};});const ws=XLSX.utils.json_to_sheet(ticketsData);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'RelatorioDeAtendimentos');XLSX.writeFile(wb,'relatorio-de-atendimentos.xlsx');setPageNumber(pageNumber);// Atualiza o estado da página atual\n}catch(error){toastError(error);}finally{setLoading(false);// Define o estado de loading como false após o carregamento\n}};const handleFilter=async pageNumber=>{setLoading(true);// Define o estado de loading como true durante o carregamento\ntry{const data=await getReport({searchParam,contactId:selectedContactId,whatsappId:JSON.stringify(selectedWhatsapp),// tags: JSON.stringify(tagIds),\nusers:JSON.stringify(userIds),queueIds:JSON.stringify(queueIds),status:JSON.stringify(selectedStatus),// tags: tagIds,\ndateFrom,dateTo,page:pageNumber,// Passa o número da página para a API\npageSize:pageSize,// Passa o tamanho da página para a API\nonlyRated:onlyRated?\"true\":\"false\"});setTotalTickets(data.totalTickets.total);// Verifica se há mais resultados para definir hasMore\nsetHasMore(data.tickets.length===pageSize);setTickets(data.tickets);// Se for a primeira página, substitua os tickets\nsetPageNumber(pageNumber);// Atualiza o estado da página atual\n}catch(error){toastError(error);}finally{setLoading(false);// Define o estado de loading como false após o carregamento\n}};const handleSelectedUsers=selecteds=>{const users=selecteds.map(t=>t.id);setUserIds(users);};const handleSelectedWhatsapps=selecteds=>{const whatsapp=selecteds.map(t=>t.id);setSelectedWhatsapp(whatsapp);};const handleSelectedStatus=selecteds=>{const statusFilter=selecteds.map(t=>t.status);setSelectedStatus(statusFilter);};const IconChannel=channel=>{switch(channel){case\"facebook\":return/*#__PURE__*/React.createElement(Facebook,{style:{color:\"#3b5998\",verticalAlign:\"middle\"}});case\"instagram\":return/*#__PURE__*/React.createElement(Instagram,{style:{color:\"#e1306c\",verticalAlign:\"middle\"}});case\"whatsapp\":return/*#__PURE__*/React.createElement(WhatsApp,{style:{color:\"#25d366\",verticalAlign:\"middle\"}});default:return\"error\";}};const renderOption=option=>{if(option.number){return/*#__PURE__*/React.createElement(React.Fragment,null,IconChannel(option.channel),/*#__PURE__*/React.createElement(Typography,{component:\"span\",style:{fontSize:14,marginLeft:\"10px\",display:\"inline-flex\",alignItems:\"center\",lineHeight:\"2\"}},option.name,\" - \",option.number));}else{return\"\".concat(i18n.t(\"newTicketModal.add\"),\" \").concat(option.name);}};const handleSelectOption=(e,newValue)=>{setSelectedContactId(newValue.id);setSearchParam(\"\");};const renderOptionLabel=option=>{if(option.number){return\"\".concat(option.name,\" - \").concat(option.number);}else{return\"\".concat(option.name);}};const filter=createFilterOptions({trim:true});const createAddContactOption=(filterOptions,params)=>{const filtered=filter(filterOptions,params);if(params.inputValue!==\"\"&&!loading&&searchParam.length>=3){filtered.push({name:\"\".concat(params.inputValue)});}return filtered;};const renderContactAutocomplete=()=>{return/*#__PURE__*/React.createElement(Grid,{xs:12,item:true},/*#__PURE__*/React.createElement(Autocomplete,{fullWidth:true,options:options,loading:loading,clearOnBlur:true,autoHighlight:true,freeSolo:true,size:\"small\",clearOnEscape:true,getOptionLabel:renderOptionLabel,renderOption:renderOption,filterOptions:createAddContactOption,onChange:(e,newValue)=>handleSelectOption(e,newValue),renderInput:params=>/*#__PURE__*/React.createElement(TextField,Object.assign({},params,{label:i18n.t(\"newTicketModal.fieldLabel\"),variant:\"outlined\",autoFocus:true,size:\"small\",onChange:e=>setSearchParam(e.target.value)// onKeyPress={(e, newValue) => handleSelectOption(e, newValue)}\n,InputProps:{...params.InputProps,endAdornment:/*#__PURE__*/React.createElement(React.Fragment,null,loading?/*#__PURE__*/React.createElement(CircularProgress,{color:\"inherit\",size:20}):null,params.InputProps.endAdornment)}}))}));};return/*#__PURE__*/React.createElement(MainContainer,{className:classes.mainContainer},openTicketMessageDialog&&/*#__PURE__*/React.createElement(ShowTicketLogModal,{isOpen:openTicketMessageDialog,handleClose:()=>setOpenTicketMessageDialog(false),ticketId:ticketOpen.id}),/*#__PURE__*/React.createElement(Title,null,i18n.t(\"reports.title\")),/*#__PURE__*/React.createElement(MainHeader,{className:classes.mainHeaderFilter,style:{display:'flex'}},/*#__PURE__*/React.createElement(Paper,{className:classes.mainPaperFilter},/*#__PURE__*/React.createElement(\"div\",{style:{paddingTop:'15px'}}),/*#__PURE__*/React.createElement(Grid,{container:true,spacing:1},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:3,xl:3},renderContactAutocomplete()),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:3,xl:3},/*#__PURE__*/React.createElement(WhatsappsFilter,{onFiltered:handleSelectedWhatsapps})),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:3,xl:3},/*#__PURE__*/React.createElement(StatusFilter,{onFiltered:handleSelectedStatus})),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:3,xl:3},/*#__PURE__*/React.createElement(UsersFilter,{onFiltered:handleSelectedUsers})),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,md:3,xl:3,style:{marginTop:'-13px'}},/*#__PURE__*/React.createElement(QueueSelectCustom,{selectedQueueIds:queueIds,onChange:values=>setQueueIds(values)})),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,sm:3,md:3},/*#__PURE__*/React.createElement(TextField,{label:\"Data Inicial\",type:\"date\",value:dateFrom,variant:\"outlined\",fullWidth:true,size:\"small\",onChange:e=>setDateFrom(e.target.value),InputLabelProps:{shrink:true}})),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,sm:3,md:3},/*#__PURE__*/React.createElement(TextField,{label:\"Data Final\",type:\"date\",value:dateTo,variant:\"outlined\",fullWidth:true,size:\"small\",onChange:e=>setDateTo(e.target.value),InputLabelProps:{shrink:true}})),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,sm:3,md:3,style:{display:'flex',justifyContent:'center'}},/*#__PURE__*/React.createElement(FormControlLabel,{control:/*#__PURE__*/React.createElement(Switch,{color:\"primary\",checked:onlyRated,onChange:()=>setOnlyRated(!onlyRated)}),label:i18n.t(\"reports.buttons.onlyRated\")}),/*#__PURE__*/React.createElement(IconButton,{onClick:exportarGridParaExcel,\"aria-label\":\"Exportar para Excel\"},/*#__PURE__*/React.createElement(SaveAlt,null)),/*#__PURE__*/React.createElement(Button,{variant:\"contained\",color:\"primary\",onClick:()=>handleFilter(pageNumber),size:\"small\"},i18n.t(\"reports.buttons.filter\")))))),/*#__PURE__*/React.createElement(Paper,{className:classes.mainPaperTable,variant:\"outlined\"},/*#__PURE__*/React.createElement(Table,{size:\"small\",id:\"grid-attendants\"},/*#__PURE__*/React.createElement(TableHead,null,/*#__PURE__*/React.createElement(TableRow,null,/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},i18n.t(\"reports.table.id\")),/*#__PURE__*/React.createElement(TableCell,{align:\"left\"},i18n.t(\"reports.table.whatsapp\")),/*#__PURE__*/React.createElement(TableCell,{align:\"left\"},i18n.t(\"reports.table.contact\")),/*#__PURE__*/React.createElement(TableCell,{align:\"left\"},i18n.t(\"reports.table.user\")),/*#__PURE__*/React.createElement(TableCell,{align:\"left\"},i18n.t(\"reports.table.queue\")),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},i18n.t(\"reports.table.status\")),/*#__PURE__*/React.createElement(TableCell,{align:\"left\"},i18n.t(\"reports.table.lastMessage\")),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},i18n.t(\"reports.table.dateOpen\")),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},i18n.t(\"reports.table.dateClose\")),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},i18n.t(\"reports.table.supportTime\")),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},i18n.t(\"reports.table.NPS\")),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},i18n.t(\"reports.table.actions\")))),/*#__PURE__*/React.createElement(TableBody,null,/*#__PURE__*/React.createElement(React.Fragment,null,tickets.map(ticket=>/*#__PURE__*/React.createElement(TableRow,{key:ticket.id},/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},ticket.id),/*#__PURE__*/React.createElement(TableCell,{align:\"left\"},ticket===null||ticket===void 0?void 0:ticket.whatsappName),/*#__PURE__*/React.createElement(TableCell,{align:\"left\"},ticket===null||ticket===void 0?void 0:ticket.contactName),/*#__PURE__*/React.createElement(TableCell,{align:\"left\"},ticket===null||ticket===void 0?void 0:ticket.userName),/*#__PURE__*/React.createElement(TableCell,{align:\"left\"},ticket===null||ticket===void 0?void 0:ticket.queueName),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},ticket===null||ticket===void 0?void 0:ticket.status),/*#__PURE__*/React.createElement(TableCell,{align:\"left\"},ticket===null||ticket===void 0?void 0:ticket.lastMessage),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},ticket===null||ticket===void 0?void 0:ticket.createdAt),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},ticket===null||ticket===void 0?void 0:ticket.closedAt),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},ticket===null||ticket===void 0?void 0:ticket.supportTime),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},ticket===null||ticket===void 0?void 0:ticket.NPS),/*#__PURE__*/React.createElement(TableCell,{align:\"center\"},/*#__PURE__*/React.createElement(Typography,{noWrap:true,component:\"span\",variant:\"body2\",color:\"textPrimary\"},/*#__PURE__*/React.createElement(Tooltip,{title:\"Logs do Ticket\"},/*#__PURE__*/React.createElement(History,{onClick:()=>{setOpenTicketMessageDialog(true);setTicketOpen(ticket);},fontSize:\"small\",style:{color:blue[700],cursor:\"pointer\",marginLeft:10,verticalAlign:\"middle\"}})),/*#__PURE__*/React.createElement(Tooltip,{title:\"Acessar Ticket\"},/*#__PURE__*/React.createElement(Forward,{onClick:()=>{history.push(\"/tickets/\".concat(ticket.uuid));},fontSize:\"small\",style:{color:green[700],cursor:\"pointer\",marginLeft:10,verticalAlign:\"middle\"}})))))),loading&&/*#__PURE__*/React.createElement(TableRowSkeleton,{avatar:true,columns:3}))))),/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(Grid,{container:true},/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,sm:10,md:10},/*#__PURE__*/React.createElement(Pagination,{count:Math.ceil(totalTickets/pageSize)// Calcula o nmero total de páginas com base no nmero total de tickets e no tamanho da página\n,page:pageNumber// Define a página atual\n,onChange:(event,value)=>handleFilter(value)// Função de callback para mudanças de página\n})),/*#__PURE__*/React.createElement(Grid,{item:true,xs:12,sm:2,md:2},/*#__PURE__*/React.createElement(FormControl,{margin:\"dense\",variant:\"outlined\",fullWidth:true},/*#__PURE__*/React.createElement(InputLabel,null,i18n.t(\"tickets.search.ticketsPerPage\")),/*#__PURE__*/React.createElement(Select,{labelId:\"dialog-select-prompt-label\",id:\"dialog-select-prompt\",name:\"pageSize\",value:pageSize,onChange:e=>{setPageSize(e.target.value);},label:i18n.t(\"tickets.search.ticketsPerPage\"),fullWidth:true,MenuProps:{anchorOrigin:{vertical:\"center\",horizontal:\"left\"},transformOrigin:{vertical:\"center\",horizontal:\"left\"},getContentAnchorEl:null}},/*#__PURE__*/React.createElement(MenuItem,{value:5},\"5\"),/*#__PURE__*/React.createElement(MenuItem,{value:10},\"10\"),/*#__PURE__*/React.createElement(MenuItem,{value:20},\"20\"),/*#__PURE__*/React.createElement(MenuItem,{value:50},\"50\")))))));};export default Reports;","map":null,"metadata":{},"sourceType":"module"}